# æœåŠ¡å™¨Nginxå®‰å…¨ä¿®å¤éƒ¨ç½²æŒ‡å—

## ğŸ“‹ å½“å‰çŠ¶æ€

- **æœåŠ¡å™¨IP**: 222.204.4.108
- **Nginxç‰ˆæœ¬**: 1.28.0 âœ…ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼Œæ— é«˜å±æ¼æ´ï¼‰
- **ç½‘ç«™æ ¹ç›®å½•**: /var/www/html
- **é…ç½®æ–‡ä»¶**: /etc/nginx/sites-available/default
- **å½“å‰é—®é¢˜**: 
  - âŒ ç¼ºå°‘å®‰å…¨å“åº”å¤´
  - âŒ æœªé™åˆ¶æ¶æ„Hostå¤´
  - âŒ æœªç¦ç”¨å±é™©HTTPæ–¹æ³•
  - âŒ å­˜åœ¨å¤§é‡æµ‹è¯•æ–‡ä»¶æš´éœ²åœ¨å¤–

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: å¤‡ä»½å½“å‰é…ç½®

```bash
# å¤‡ä»½Nginxé…ç½®
sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.backup.$(date +%Y%m%d)

# å¤‡ä»½nginx.conf
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup.$(date +%Y%m%d)
```

### æ­¥éª¤2: ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶ï¼ˆnginx.confï¼‰

```bash
# ç¼–è¾‘nginx.conf
sudo nano /etc/nginx/nginx.conf
```

åœ¨ `http` å—ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰ï¼š

```nginx
http {
    # ... å…¶ä»–é…ç½® ...
    
    # éšè—Nginxç‰ˆæœ¬å·
    server_tokens off;
    
    # ç¦ç”¨ç›®å½•åˆ—è¡¨
    autoindex off;
    
    # é™åˆ¶è¯·æ±‚æ–¹æ³•
    map $request_method $not_allowed_method {
        default 1;
        GET 0;
        POST 0;
        PUT 0;
        DELETE 0;
        HEAD 0;
        OPTIONS 0;
    }
    
    # ... å…¶ä»–é…ç½® ...
}
```

### æ­¥éª¤3: æ›¿æ¢ sites-available/default é…ç½®

```bash
# æ–¹æ³•1: ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šç¼–è¾‘
sudo nano /etc/nginx/sites-available/default

# æ–¹æ³•2: ä»æœ¬åœ°ä¸Šä¼ ï¼ˆæ¨èï¼‰
# åœ¨æœ¬åœ°æ‰§è¡Œï¼š
scp server-nginx-default root@222.204.4.108:/tmp/default.new

# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š
sudo mv /tmp/default.new /etc/nginx/sites-available/default
```

å°†é…ç½®æ–‡ä»¶å†…å®¹æ›¿æ¢ä¸º `server-nginx-default` æ–‡ä»¶çš„å†…å®¹ã€‚

### æ­¥éª¤4: æµ‹è¯•é…ç½®

```bash
# æµ‹è¯•Nginxé…ç½®è¯­æ³•
sudo nginx -t

# åº”è¯¥çœ‹åˆ°ï¼š
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test is successful
```

### æ­¥éª¤5: é‡è½½Nginx

```bash
# é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰
sudo systemctl reload nginx

# æˆ–è€…é‡å¯Nginx
sudo systemctl restart nginx

# éªŒè¯æœåŠ¡çŠ¶æ€
sudo systemctl status nginx
```

### æ­¥éª¤6: éªŒè¯ä¿®å¤æ•ˆæœ

```bash
# 1. æµ‹è¯•ä¸»é¡µè®¿é—®
curl -I http://222.204.4.108/

# 2. æµ‹è¯•å‰ç«¯è·¯ç”±ï¼ˆloginé¡µé¢ï¼‰
curl -I http://222.204.4.108/login

# 3. æ£€æŸ¥å®‰å…¨å“åº”å¤´
curl -I http://222.204.4.108/ | grep -E "X-Frame-Options|Content-Security-Policy|X-Content-Type-Options"

# 4. æµ‹è¯•æ¶æ„Hostå¤´ï¼ˆåº”è¯¥è¿”å›403ï¼‰
curl -H "Host: evilhost" http://222.204.4.108/

# 5. æµ‹è¯•TRACEæ–¹æ³•ï¼ˆåº”è¯¥è¿”å›405ï¼‰
curl -X TRACE http://222.204.4.108/api/

# 6. æµ‹è¯•éšè—æ–‡ä»¶è®¿é—®ï¼ˆåº”è¯¥è¿”å›403ï¼‰
curl http://222.204.4.108/.git/config
```

---

## ğŸ”§ è¯¦ç»†é…ç½®è¯´æ˜

### 1. é»˜è®¤Serverå—ï¼ˆé˜²å¾¡æ¶æ„Hostå¤´ï¼‰

```nginx
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    return 444;  # å…³é—­è¿æ¥
}
```

**ä½œç”¨**: æ‹’ç»æ‰€æœ‰ä½¿ç”¨éæ³•Hostå¤´çš„è¯·æ±‚ã€‚

### 2. Hostå¤´éªŒè¯

```nginx
if ($host !~* ^222\.204\.4\.108$ ) {
    return 403;
}
```

**ä½œç”¨**: ä»…å…è®¸ `222.204.4.108` ä½œä¸ºåˆæ³•Hostã€‚

### 3. å‰ç«¯è·¯ç”±æ”¯æŒ

```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

**ä½œç”¨**: 
- âœ… æ”¯æŒ `http://222.204.4.108/login`
- âœ… æ”¯æŒ `http://222.204.4.108/register`
- âœ… æ”¯æŒæ‰€æœ‰å‰ç«¯è·¯ç”±

**å·¥ä½œåŸç†**:
1. å…ˆå°è¯•æŸ¥æ‰¾å®é™…æ–‡ä»¶ `$uri`
2. å†å°è¯•æŸ¥æ‰¾ç›®å½• `$uri/`
3. å¦‚æœéƒ½ä¸å­˜åœ¨ï¼Œè¿”å› `index.html`ï¼ˆç”±å‰ç«¯è·¯ç”±å¤„ç†ï¼‰

### 4. APIä»£ç†å®‰å…¨åŠ å›º

```nginx
location /api/ {
    limit_except GET POST PUT DELETE HEAD OPTIONS {
        deny all;
    }
    # ... ä»£ç†é…ç½®
}
```

**ä½œç”¨**: ç¦ç”¨TRACEã€TRACKç­‰å±é™©HTTPæ–¹æ³•ã€‚

### 5. æµ‹è¯•æ–‡ä»¶è®¿é—®é™åˆ¶

```nginx
location ~* (test-.*\.html|debug-.*\.html|cleanup-.*\.html)$ {
    deny all;
    return 404;
}
```

**ä½œç”¨**: ç¦æ­¢å¤–éƒ¨è®¿é—®æµ‹è¯•æ–‡ä»¶ï¼Œé˜²æ­¢ä¿¡æ¯æ³„éœ²ã€‚

**å»ºè®®**: ç”Ÿäº§ç¯å¢ƒåº”è¯¥åˆ é™¤è¿™äº›æµ‹è¯•æ–‡ä»¶ï¼š
```bash
cd /var/www/html
sudo rm -f test-*.html debug-*.html cleanup-*.html diagnose-*.html verify-*.html final-*.html
```

---

## ğŸ§¹ æ¸…ç†æµ‹è¯•æ–‡ä»¶ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

```bash
# è¿›å…¥ç½‘ç«™ç›®å½•
cd /var/www/html

# åˆ—å‡ºæ‰€æœ‰æµ‹è¯•æ–‡ä»¶
ls -la | grep -E "(test-|debug-|cleanup-|diagnose-|verify-|final-)"

# åˆ é™¤æµ‹è¯•æ–‡ä»¶
sudo rm -f test-*.html
sudo rm -f debug-*.html
sudo rm -f cleanup-*.html
sudo rm -f diagnose-*.html
sudo rm -f verify-*.html
sudo rm -f final-*.html
sudo rm -f simple-test.html

# éªŒè¯åˆ é™¤ç»“æœ
ls -la
```

**ä¿ç•™çš„æ–‡ä»¶**:
- âœ… index.htmlï¼ˆä¸»é¡µï¼‰
- âœ… assets/ï¼ˆå‰ç«¯èµ„æºï¼‰
- âœ… images/ï¼ˆå›¾ç‰‡ï¼‰
- âœ… videos/ï¼ˆè§†é¢‘ï¼‰
- âœ… audio/ï¼ˆéŸ³é¢‘ï¼‰
- âœ… vite.svgï¼ˆå›¾æ ‡ï¼‰

---

## ğŸ” éªŒè¯å‰ç«¯è·¯ç”±

### æµ‹è¯•æ‰€æœ‰ä¸»è¦è·¯ç”±

```bash
# 1. ä¸»é¡µ
curl -I http://222.204.4.108/
# æœŸæœ›: 200 OK

# 2. ç™»å½•é¡µ
curl -I http://222.204.4.108/login
# æœŸæœ›: 200 OKï¼Œè¿”å›index.html

# 3. æ³¨å†Œé¡µ
curl -I http://222.204.4.108/register
# æœŸæœ›: 200 OKï¼Œè¿”å›index.html

# 4. è¯¾ç¨‹é¡µ
curl -I http://222.204.4.108/courses
# æœŸæœ›: 200 OKï¼Œè¿”å›index.html

# 5. APIæ¥å£
curl -I http://222.204.4.108/api/health
# æœŸæœ›: æ ¹æ®åç«¯å®é™…æƒ…å†µ
```

### æµè§ˆå™¨æµ‹è¯•

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
- http://222.204.4.108/
- http://222.204.4.108/login
- http://222.204.4.108/register

æ‰€æœ‰é¡µé¢éƒ½åº”è¯¥æ­£å¸¸æ˜¾ç¤ºï¼Œä¸ä¼šå‡ºç°404é”™è¯¯ã€‚

---

## ğŸ“Š å®‰å…¨æ£€æµ‹

### åœ¨çº¿å·¥å…·æ£€æµ‹

1. **SecurityHeaders.com**
   ```
   è®¿é—®: https://securityheaders.com
   è¾“å…¥: http://222.204.4.108
   æœŸæœ›è¯„åˆ†: Açº§
   ```

2. **Mozilla Observatory**
   ```
   è®¿é—®: https://observatory.mozilla.org
   è¾“å…¥: http://222.204.4.108
   æœŸæœ›è¯„åˆ†: Bçº§æˆ–æ›´é«˜
   ```

### æ‰‹åŠ¨å®‰å…¨æµ‹è¯•

```bash
# 1. æ£€æŸ¥æœåŠ¡å™¨ç‰ˆæœ¬ï¼ˆåº”è¯¥ä¸æ˜¾ç¤ºè¯¦ç»†ç‰ˆæœ¬ï¼‰
curl -I http://222.204.4.108/ | grep Server
# æœŸæœ›: Server: nginx

# 2. æ£€æŸ¥æ‰€æœ‰å®‰å…¨å“åº”å¤´
curl -I http://222.204.4.108/

# åº”è¯¥åŒ…å«ï¼š
# X-Frame-Options: SAMEORIGIN
# X-Content-Type-Options: nosniff
# X-XSS-Protection: 1; mode=block
# Content-Security-Policy: ...
# Referrer-Policy: ...
# Permissions-Policy: ...

# 3. æµ‹è¯•æ¶æ„è¯·æ±‚
curl -H "Host: evil.com" http://222.204.4.108/
# æœŸæœ›: 403 Forbidden æˆ–æ— å“åº”

# 4. æµ‹è¯•å±é™©æ–¹æ³•
curl -X TRACE http://222.204.4.108/api/
# æœŸæœ›: 405 Method Not Allowed

# 5. æµ‹è¯•ç›®å½•éå†
curl http://222.204.4.108/../../../etc/passwd
# æœŸæœ›: 404 æˆ– 403
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å…³äº Content-Security-Policy

å¦‚æœå‰ç«¯ä½¿ç”¨äº†å¤–éƒ¨CDNæˆ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´CSPç­–ç•¥ï¼š

```nginx
# ç¤ºä¾‹ï¼šå…è®¸ä»ç‰¹å®šCDNåŠ è½½èµ„æº
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.example.com; style-src 'self' 'unsafe-inline' https://cdn.example.com; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.example.com; frame-ancestors 'self';" always;
```

### 2. å…³äºå‰ç«¯è·¯ç”±

é…ç½®ä¸­çš„ `try_files $uri $uri/ /index.html;` ç¡®ä¿ï¼š
- æ‰€æœ‰å‰ç«¯è·¯ç”±ï¼ˆå¦‚ /login, /registerï¼‰éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- åˆ·æ–°é¡µé¢ä¸ä¼šå‡ºç°404é”™è¯¯
- ç›´æ¥è®¿é—®æ·±å±‚è·¯ç”±ä¹Ÿèƒ½æ­£å¸¸åŠ è½½

### 3. å…³äºåç«¯API

ç¡®ä¿åç«¯æœåŠ¡åœ¨ `localhost:8082` æ­£å¸¸è¿è¡Œï¼š

```bash
# æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
curl http://localhost:8082/api/health

# æˆ–æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep 8082
```

### 4. å…³äºæµ‹è¯•æ–‡ä»¶

ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®åˆ é™¤æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ï¼š
- test-*.html
- debug-*.html
- cleanup-*.html
- diagnose-*.html
- verify-*.html
- final-*.html

è¿™äº›æ–‡ä»¶å¯èƒ½æ³„éœ²ç³»ç»Ÿä¿¡æ¯æˆ–æä¾›æ”»å‡»å…¥å£ã€‚

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœæ–°é…ç½®å¯¼è‡´é—®é¢˜ï¼š

```bash
# æ¢å¤å¤‡ä»½çš„é…ç½®
sudo cp /etc/nginx/sites-available/default.backup.YYYYMMDD /etc/nginx/sites-available/default

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½Nginx
sudo systemctl reload nginx
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰
- [ ] å·²å¤‡ä»½ /etc/nginx/sites-available/default
- [ ] å·²å¤‡ä»½ /etc/nginx/nginx.conf
- [ ] å·²é˜…è¯»æ‰€æœ‰æ³¨æ„äº‹é¡¹

### éƒ¨ç½²ä¸­
- [ ] ä¿®æ”¹äº† nginx.confï¼ˆæ·»åŠ  server_tokens off ç­‰ï¼‰
- [ ] æ›¿æ¢äº† sites-available/default
- [ ] nginx -t æµ‹è¯•é€šè¿‡
- [ ] Nginxå·²æˆåŠŸé‡è½½

### éƒ¨ç½²å
- [ ] ä¸»é¡µæ­£å¸¸è®¿é—® (http://222.204.4.108/)
- [ ] ç™»å½•é¡µæ­£å¸¸è®¿é—® (http://222.204.4.108/login)
- [ ] å®‰å…¨å“åº”å¤´å·²ç”Ÿæ•ˆ
- [ ] TRACEæ–¹æ³•å·²ç¦ç”¨
- [ ] æ¶æ„Hostå¤´è¢«æ‹’ç»
- [ ] APIæ¥å£æ­£å¸¸å·¥ä½œ
- [ ] å·²åˆ é™¤æµ‹è¯•æ–‡ä»¶
- [ ] å·²ä½¿ç”¨åœ¨çº¿å·¥å…·éªŒè¯å®‰å…¨æ€§

---

## ğŸ“ˆ é¢„æœŸæ”¹å–„

### ä¿®å¤çš„æ¼æ´
- âœ… ä¸­å±: åŸŸåè®¿é—®é™åˆ¶ä¸ä¸¥æ ¼
- âœ… ä½å±: HTTPå®‰å…¨å“åº”å¤´ç¼ºå¤±ï¼ˆ8ä¸ªï¼‰
- âœ… ä½å±: å¯ç”¨å±é™©çš„Method (TRACE)
- âœ… ä½å±: ä¿¡æ¯æ³„éœ²ï¼ˆæœåŠ¡å™¨ç‰ˆæœ¬ï¼‰
- âœ… ä½å±: æµ‹è¯•æ–‡ä»¶æš´éœ²

### å®‰å…¨è¯„åˆ†
- **SecurityHeaders.com**: Cçº§ â†’ **Açº§**
- **Webé£é™©ç­‰çº§**: 5.0/10 â†’ **2.0/10**

### åŠŸèƒ½æ”¹å–„
- âœ… å‰ç«¯è·¯ç”±å®Œå…¨æ”¯æŒï¼ˆ/login, /registerç­‰ï¼‰
- âœ… é¡µé¢åˆ·æ–°ä¸ä¼š404
- âœ… ç›´æ¥è®¿é—®æ·±å±‚è·¯ç”±æ­£å¸¸

---

## ğŸ“ æ•…éšœæ’æŸ¥

### é—®é¢˜1: é…ç½®æµ‹è¯•å¤±è´¥

```bash
sudo nginx -t
# å¦‚æœæŠ¥é”™ï¼Œæ£€æŸ¥è¯­æ³•é”™è¯¯
```

**è§£å†³**: ä»”ç»†æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•ï¼Œç‰¹åˆ«æ˜¯æ‹¬å·ã€åˆ†å·ã€‚

### é—®é¢˜2: å‰ç«¯è·¯ç”±404

**ç—‡çŠ¶**: è®¿é—® http://222.204.4.108/login è¿”å›404

**è§£å†³**:
```bash
# æ£€æŸ¥ try_files é…ç½®
grep -A 2 "location /" /etc/nginx/sites-available/default

# åº”è¯¥çœ‹åˆ°ï¼š
# location / {
#     try_files $uri $uri/ /index.html;
# }
```

### é—®é¢˜3: APIè¯·æ±‚å¤±è´¥

**ç—‡çŠ¶**: å‰ç«¯æ— æ³•è°ƒç”¨åç«¯API

**è§£å†³**:
```bash
# 1. æ£€æŸ¥åç«¯æœåŠ¡
curl http://localhost:8082/api/health

# 2. æ£€æŸ¥ä»£ç†é…ç½®
grep -A 10 "location /api/" /etc/nginx/sites-available/default

# 3. æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

### é—®é¢˜4: é™æ€èµ„æºåŠ è½½å¤±è´¥

**ç—‡çŠ¶**: CSSã€JSæ–‡ä»¶æ— æ³•åŠ è½½

**è§£å†³**:
```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /var/www/html/assets/

# åº”è¯¥æ˜¯ 644 æƒé™
sudo chmod 644 /var/www/html/assets/*
```

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **å¯ç”¨HTTPS**ï¼ˆå¼ºçƒˆæ¨èï¼‰
   ```bash
   sudo apt install certbot python3-certbot-nginx
   sudo certbot --nginx -d yourdomain.com
   ```

2. **é…ç½®é˜²ç«å¢™**
   ```bash
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   sudo ufw enable
   ```

3. **è®¾ç½®æ—¥å¿—è½®è½¬**
   ```bash
   # æ£€æŸ¥æ—¥å¿—è½®è½¬é…ç½®
   cat /etc/logrotate.d/nginx
   ```

4. **ç›‘æ§å’Œå‘Šè­¦**
   - è®¾ç½®Nginxè®¿é—®æ—¥å¿—ç›‘æ§
   - é…ç½®å¼‚å¸¸æµé‡å‘Šè­¦
   - ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ä¿®æ”¹æ—¥æœŸ**: 2025-11-02  
**é€‚ç”¨ç¯å¢ƒ**: Ubuntu + Nginx 1.28.0  
**ä¿®æ”¹äººå‘˜**: AI Assistant

**é‡è¦**: éƒ¨ç½²å®Œæˆåï¼Œè¯·åŠ¡å¿…æµ‹è¯•æ‰€æœ‰åŠŸèƒ½ï¼Œç¡®ä¿ç½‘ç«™æ­£å¸¸è¿è¡Œï¼

