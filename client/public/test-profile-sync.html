<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒæ•°æ®åŒæ­¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin: 10px 0;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .data-label {
            font-weight: bold;
            color: #495057;
        }
        .data-value {
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ ä¸ªäººä¸­å¿ƒæ•°æ®åŒæ­¥æµ‹è¯•</h1>
    
    <div class="container">
        <div class="section">
            <h3>ğŸ“Š å½“å‰ç”¨æˆ·æ•°æ®</h3>
            <div id="currentData" class="data-display">
                <div class="data-item">
                    <span class="data-label">ç­‰çº§:</span>
                    <span class="data-value" id="currentLevel">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">ç»éªŒå€¼:</span>
                    <span class="data-value" id="currentExp">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">æ€»å¾—åˆ†:</span>
                    <span class="data-value" id="currentScore">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">å·²å®Œæˆç« èŠ‚:</span>
                    <span class="data-value" id="currentChapters">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">å­¦ä¹ æ—¶é—´:</span>
                    <span class="data-value" id="currentStudyTime">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">æˆå°±æ•°é‡:</span>
                    <span class="data-value" id="currentAchievements">-</span>
                </div>
            </div>
            <button onclick="loadCurrentData()">ğŸ”„ åˆ·æ–°å½“å‰æ•°æ®</button>
        </div>

        <div class="section">
            <h3>ğŸ¯ ç»éªŒå€¼æ›´æ–°æµ‹è¯•</h3>
            <button onclick="simulateQuizComplete()">ğŸ“ æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ (+50ç»éªŒ)</button>
            <button onclick="simulateChapterComplete()">ğŸ“š æ¨¡æ‹Ÿç« èŠ‚å®Œæˆ (+100ç»éªŒ)</button>
            <button onclick="simulateCustomExp()">âš¡ è‡ªå®šä¹‰ç»éªŒå€¼æ›´æ–°</button>
            <button onclick="triggerExperienceEvent()">ğŸ”” æ‰‹åŠ¨è§¦å‘ç»éªŒå€¼äº‹ä»¶</button>
        </div>

        <div class="section">
            <h3>ğŸ‘‚ äº‹ä»¶ç›‘å¬æµ‹è¯•</h3>
            <div id="listenerStatus" class="status info">äº‹ä»¶ç›‘å¬å™¨çŠ¶æ€: æœªçŸ¥</div>
            <button onclick="startEventListener()" class="success">â–¶ï¸ å¼€å§‹ç›‘å¬ç»éªŒå€¼äº‹ä»¶</button>
            <button onclick="stopEventListener()" class="danger">â¹ï¸ åœæ­¢ç›‘å¬ç»éªŒå€¼äº‹ä»¶</button>
            <button onclick="testEventSystem()">ğŸ§ª æµ‹è¯•äº‹ä»¶ç³»ç»Ÿ</button>
        </div>

        <div class="section">
            <h3>ğŸ  ä¸ªäººä¸­å¿ƒé¡µé¢æµ‹è¯•</h3>
            <button onclick="openProfilePage()">ğŸ”— æ‰“å¼€ä¸ªäººä¸­å¿ƒé¡µé¢</button>
            <button onclick="testProfileUpdate()">ğŸ”„ æµ‹è¯•ä¸ªäººä¸­å¿ƒæ•°æ®æ›´æ–°</button>
            <button onclick="checkProfileEventListener()">ğŸ‘‚ æ£€æŸ¥ä¸ªäººä¸­å¿ƒäº‹ä»¶ç›‘å¬</button>
        </div>

        <div class="section">
            <h3>ğŸ” é—®é¢˜è¯Šæ–­</h3>
            <button onclick="diagnoseIssue()">ğŸ©º è¯Šæ–­åŒæ­¥é—®é¢˜</button>
            <button onclick="checkAPIEndpoints()">ğŸŒ æ£€æŸ¥APIç«¯ç‚¹</button>
            <button onclick="verifyEventSystem()">âœ… éªŒè¯äº‹ä»¶ç³»ç»Ÿ</button>
            <button onclick="clearLogs()" class="danger">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="section">
            <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
            <div id="testLog" class="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...
</div>
        </div>
    </div>

    <script>
        let eventListener = null;
        let isListening = false;

        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            // é…ç½®æ–‡ä»¶åŒæ­¥æµ‹è¯•æ—¥å¿—
        }

        // æ›´æ–°ç›‘å¬å™¨çŠ¶æ€æ˜¾ç¤º
        function updateListenerStatus(status, type = 'info') {
            const statusElement = document.getElementById('listenerStatus');
            statusElement.textContent = `äº‹ä»¶ç›‘å¬å™¨çŠ¶æ€: ${status}`;
            statusElement.className = `status ${type}`;
        }

        // åŠ è½½å½“å‰ç”¨æˆ·æ•°æ®
        async function loadCurrentData() {
            log('å¼€å§‹åŠ è½½å½“å‰ç”¨æˆ·æ•°æ®...');
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    log('æœªæ‰¾åˆ°ç™»å½•token', 'error');
                    return;
                }

                const response = await fetch('/api/level/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.code === 200) {
                        const data = result.data;
                        document.getElementById('currentLevel').textContent = data.level || '-';
                        document.getElementById('currentExp').textContent = data.experience || '-';
                        document.getElementById('currentScore').textContent = data.totalScore || '-';
                        document.getElementById('currentChapters').textContent = data.completedChapters || '-';
                        document.getElementById('currentStudyTime').textContent = data.studyTime || '-';
                        document.getElementById('currentAchievements').textContent = data.achievementCount || '-';
                        log('ç”¨æˆ·æ•°æ®åŠ è½½æˆåŠŸ', 'success');
                        log(`æ•°æ®è¯¦æƒ…: ç­‰çº§${data.level}, ç»éªŒ${data.experience}, å¾—åˆ†${data.totalScore}, ç« èŠ‚${data.completedChapters}`);
                    } else {
                        log(`APIè¿”å›é”™è¯¯: ${result.message}`, 'error');
                    }
                } else {
                    log(`HTTPé”™è¯¯: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ
        async function simulateQuizComplete() {
            log('æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆï¼Œå¢åŠ 50ç»éªŒå€¼...');
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/level/add-experience', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experience: 50,
                        activityType: 'quiz_complete',
                        chapterId: 1,
                        score: 85
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('æµ‹éªŒå®Œæˆæ¨¡æ‹ŸæˆåŠŸ', 'success');
                    log(`è¿”å›æ•°æ®: ${JSON.stringify(result.data)}`);
                    
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´åæ£€æŸ¥æ•°æ®æ˜¯å¦æ›´æ–°
                    setTimeout(() => {
                        loadCurrentData();
                        log('å·²è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œè¯·æ£€æŸ¥ä¸ªäººä¸­å¿ƒæ˜¯å¦åŒæ­¥æ›´æ–°');
                    }, 1000);
                } else {
                    log(`æ¨¡æ‹Ÿæµ‹éªŒå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`æ¨¡æ‹Ÿæµ‹éªŒé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ¨¡æ‹Ÿç« èŠ‚å®Œæˆ
        async function simulateChapterComplete() {
            log('æ¨¡æ‹Ÿç« èŠ‚å®Œæˆï¼Œå¢åŠ 100ç»éªŒå€¼...');
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/level/add-experience', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experience: 100,
                        activityType: 'chapter_complete',
                        chapterId: 2,
                        score: 95
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('ç« èŠ‚å®Œæˆæ¨¡æ‹ŸæˆåŠŸ', 'success');
                    log(`è¿”å›æ•°æ®: ${JSON.stringify(result.data)}`);
                    
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´åæ£€æŸ¥æ•°æ®æ˜¯å¦æ›´æ–°
                    setTimeout(() => {
                        loadCurrentData();
                        log('å·²è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œè¯·æ£€æŸ¥ä¸ªäººä¸­å¿ƒæ˜¯å¦åŒæ­¥æ›´æ–°');
                    }, 1000);
                } else {
                    log(`æ¨¡æ‹Ÿç« èŠ‚å®Œæˆå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`æ¨¡æ‹Ÿç« èŠ‚å®Œæˆé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // è‡ªå®šä¹‰ç»éªŒå€¼æ›´æ–°
        function simulateCustomExp() {
            const exp = prompt('è¯·è¾“å…¥è¦å¢åŠ çš„ç»éªŒå€¼:', '30');
            if (exp && !isNaN(exp)) {
                customExpUpdate(parseInt(exp));
            }
        }

        async function customExpUpdate(experience) {
            log(`è‡ªå®šä¹‰ç»éªŒå€¼æ›´æ–°ï¼Œå¢åŠ ${experience}ç»éªŒå€¼...`);
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/level/add-experience', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experience: experience,
                        activityType: 'custom_test',
                        chapterId: 0,
                        score: 0
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('è‡ªå®šä¹‰ç»éªŒå€¼æ›´æ–°æˆåŠŸ', 'success');
                    log(`è¿”å›æ•°æ®: ${JSON.stringify(result.data)}`);
                    
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´åæ£€æŸ¥æ•°æ®æ˜¯å¦æ›´æ–°
                    setTimeout(() => {
                        loadCurrentData();
                        log('å·²è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œè¯·æ£€æŸ¥ä¸ªäººä¸­å¿ƒæ˜¯å¦åŒæ­¥æ›´æ–°');
                    }, 1000);
                } else {
                    log(`è‡ªå®šä¹‰ç»éªŒå€¼æ›´æ–°å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`è‡ªå®šä¹‰ç»éªŒå€¼æ›´æ–°é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ‰‹åŠ¨è§¦å‘ç»éªŒå€¼äº‹ä»¶
        function triggerExperienceEvent() {
            log('æ‰‹åŠ¨è§¦å‘experienceUpdatedäº‹ä»¶...');
            const event = new CustomEvent('experienceUpdated', {
                detail: {
                    type: 'manual_test',
                    experience: 25,
                    newLevel: 2,
                    timestamp: Date.now()
                }
            });
            window.dispatchEvent(event);
            log('experienceUpdatedäº‹ä»¶å·²è§¦å‘', 'success');
        }

        // å¼€å§‹ç›‘å¬ç»éªŒå€¼äº‹ä»¶
        function startEventListener() {
            if (isListening) {
                log('äº‹ä»¶ç›‘å¬å™¨å·²åœ¨è¿è¡Œ', 'warning');
                return;
            }

            eventListener = function(event) {
                log(`æ”¶åˆ°experienceUpdatedäº‹ä»¶: ${JSON.stringify(event.detail)}`, 'success');
            };

            window.addEventListener('experienceUpdated', eventListener);
            isListening = true;
            updateListenerStatus('æ­£åœ¨ç›‘å¬', 'success');
            log('å¼€å§‹ç›‘å¬experienceUpdatedäº‹ä»¶', 'success');
        }

        // åœæ­¢ç›‘å¬ç»éªŒå€¼äº‹ä»¶
        function stopEventListener() {
            if (!isListening) {
                log('äº‹ä»¶ç›‘å¬å™¨æœªè¿è¡Œ', 'warning');
                return;
            }

            window.removeEventListener('experienceUpdated', eventListener);
            eventListener = null;
            isListening = false;
            updateListenerStatus('å·²åœæ­¢', 'error');
            log('åœæ­¢ç›‘å¬experienceUpdatedäº‹ä»¶', 'success');
        }

        // æµ‹è¯•äº‹ä»¶ç³»ç»Ÿ
        function testEventSystem() {
            log('æµ‹è¯•äº‹ä»¶ç³»ç»Ÿ...');
            
            // å…ˆå¼€å§‹ç›‘å¬
            if (!isListening) {
                startEventListener();
            }
            
            // è§¦å‘æµ‹è¯•äº‹ä»¶
            setTimeout(() => {
                triggerExperienceEvent();
            }, 500);
            
            log('äº‹ä»¶ç³»ç»Ÿæµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ˜¯å¦æ”¶åˆ°äº‹ä»¶');
        }

        // æ‰“å¼€ä¸ªäººä¸­å¿ƒé¡µé¢
        function openProfilePage() {
            log('æ‰“å¼€ä¸ªäººä¸­å¿ƒé¡µé¢...');
            window.open('/profile', '_blank');
            log('ä¸ªäººä¸­å¿ƒé¡µé¢å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€');
        }

        // æµ‹è¯•ä¸ªäººä¸­å¿ƒæ•°æ®æ›´æ–°
        function testProfileUpdate() {
            log('æµ‹è¯•ä¸ªäººä¸­å¿ƒæ•°æ®æ›´æ–°æµç¨‹...');
            
            // 1. å…ˆè§¦å‘ç»éªŒå€¼æ›´æ–°
            simulateQuizComplete();
            
            // 2. ç­‰å¾…ä¸€æ®µæ—¶é—´åè§¦å‘äº‹ä»¶
            setTimeout(() => {
                triggerExperienceEvent();
                log('å·²è§¦å‘ç»éªŒå€¼äº‹ä»¶ï¼Œè¯·æ£€æŸ¥ä¸ªäººä¸­å¿ƒé¡µé¢æ˜¯å¦æ›´æ–°');
            }, 2000);
        }

        // æ£€æŸ¥ä¸ªäººä¸­å¿ƒäº‹ä»¶ç›‘å¬
        function checkProfileEventListener() {
            log('æ£€æŸ¥ä¸ªäººä¸­å¿ƒäº‹ä»¶ç›‘å¬å™¨...');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¸ªäººä¸­å¿ƒé¡µé¢åœ¨è¿è¡Œ
            const profileWindow = window.open('/profile', 'profileTest');
            
            setTimeout(() => {
                if (profileWindow) {
                    log('ä¸ªäººä¸­å¿ƒé¡µé¢å·²æ‰“å¼€ï¼Œç°åœ¨è§¦å‘æµ‹è¯•äº‹ä»¶...');
                    triggerExperienceEvent();
                    log('æµ‹è¯•äº‹ä»¶å·²è§¦å‘ï¼Œè¯·æ£€æŸ¥ä¸ªäººä¸­å¿ƒé¡µé¢æ§åˆ¶å°æ—¥å¿—');
                } else {
                    log('æ— æ³•æ‰“å¼€ä¸ªäººä¸­å¿ƒé¡µé¢', 'error');
                }
            }, 1000);
        }

        // è¯Šæ–­åŒæ­¥é—®é¢˜
        async function diagnoseIssue() {
            log('å¼€å§‹è¯Šæ–­ä¸ªäººä¸­å¿ƒæ•°æ®åŒæ­¥é—®é¢˜...');
            
            // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('token');
            if (!token) {
                log('âŒ è¯Šæ–­ç»“æœ: æœªç™»å½•', 'error');
                return;
            }
            log('âœ… ç™»å½•çŠ¶æ€: æ­£å¸¸');
            
            // 2. æ£€æŸ¥APIå¯ç”¨æ€§
            try {
                const response = await fetch('/api/level/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    log('âœ… APIè¿æ¥: æ­£å¸¸');
                } else {
                    log(`âŒ APIè¿æ¥: é”™è¯¯ (${response.status})`, 'error');
                    return;
                }
            } catch (error) {
                log(`âŒ APIè¿æ¥: å¤±è´¥ (${error.message})`, 'error');
                return;
            }
            
            // 3. æµ‹è¯•äº‹ä»¶ç³»ç»Ÿ
            log('ğŸ§ª æµ‹è¯•äº‹ä»¶ç³»ç»Ÿ...');
            testEventSystem();
            
            // 4. å»ºè®®è§£å†³æ–¹æ¡ˆ
            setTimeout(() => {
                log('ğŸ” è¯Šæ–­å®Œæˆï¼Œå»ºè®®æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®:');
                log('1. ä¸ªäººä¸­å¿ƒé¡µé¢æ˜¯å¦æ­£ç¡®ç›‘å¬experienceUpdatedäº‹ä»¶');
                log('2. handleExperienceUpdateæ–¹æ³•æ˜¯å¦æ­£ç¡®è°ƒç”¨refreshUserStats');
                log('3. refreshUserStatsæ–¹æ³•æ˜¯å¦æ­£ç¡®æ›´æ–°æ•°æ®');
                log('4. ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸè¿”å›æœ€æ–°æ•°æ®');
            }, 2000);
        }

        // æ£€æŸ¥APIç«¯ç‚¹
        async function checkAPIEndpoints() {
            log('æ£€æŸ¥APIç«¯ç‚¹å¯ç”¨æ€§...');
            const token = localStorage.getItem('token');
            
            const endpoints = [
                { name: 'ç”¨æˆ·ç»Ÿè®¡', url: '/api/level/stats' },
                { name: 'ç”¨æˆ·æˆå°±', url: '/api/level/achievements' },
                { name: 'æ·»åŠ ç»éªŒ', url: '/api/level/add-experience', method: 'POST' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const options = {
                        method: endpoint.method || 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    };
                    
                    if (endpoint.method === 'POST') {
                        options.body = JSON.stringify({
                            experience: 1,
                            activityType: 'test',
                            chapterId: 0,
                            score: 0
                        });
                    }
                    
                    const response = await fetch(endpoint.url, options);
                    
                    if (response.ok) {
                        log(`âœ… ${endpoint.name}: æ­£å¸¸`);
                    } else {
                        log(`âŒ ${endpoint.name}: é”™è¯¯ (${response.status})`, 'error');
                    }
                } catch (error) {
                    log(`âŒ ${endpoint.name}: å¤±è´¥ (${error.message})`, 'error');
                }
            }
        }

        // éªŒè¯äº‹ä»¶ç³»ç»Ÿ
        function verifyEventSystem() {
            log('éªŒè¯äº‹ä»¶ç³»ç»Ÿå®Œæ•´æ€§...');
            
            let testsPassed = 0;
            const totalTests = 3;
            
            // æµ‹è¯•1: äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œ
            try {
                const testListener = () => {};
                window.addEventListener('test', testListener);
                window.removeEventListener('test', testListener);
                log('âœ… æµ‹è¯•1: äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œ/ç§»é™¤æ­£å¸¸');
                testsPassed++;
            } catch (error) {
                log(`âŒ æµ‹è¯•1: äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œå¤±è´¥ (${error.message})`, 'error');
            }
            
            // æµ‹è¯•2: è‡ªå®šä¹‰äº‹ä»¶åˆ›å»º
            try {
                const testEvent = new CustomEvent('testEvent', { detail: { test: true } });
                log('âœ… æµ‹è¯•2: è‡ªå®šä¹‰äº‹ä»¶åˆ›å»ºæ­£å¸¸');
                testsPassed++;
            } catch (error) {
                log(`âŒ æµ‹è¯•2: è‡ªå®šä¹‰äº‹ä»¶åˆ›å»ºå¤±è´¥ (${error.message})`, 'error');
            }
            
            // æµ‹è¯•3: äº‹ä»¶è§¦å‘å’Œæ¥æ”¶
            try {
                let eventReceived = false;
                const testListener = () => { eventReceived = true; };
                
                window.addEventListener('verifyTest', testListener);
                window.dispatchEvent(new CustomEvent('verifyTest'));
                window.removeEventListener('verifyTest', testListener);
                
                if (eventReceived) {
                    log('âœ… æµ‹è¯•3: äº‹ä»¶è§¦å‘å’Œæ¥æ”¶æ­£å¸¸');
                    testsPassed++;
                } else {
                    log('âŒ æµ‹è¯•3: äº‹ä»¶æœªæ­£ç¡®æ¥æ”¶', 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•3: äº‹ä»¶è§¦å‘æµ‹è¯•å¤±è´¥ (${error.message})`, 'error');
            }
            
            // æ€»ç»“
            if (testsPassed === totalTests) {
                log(`âœ… äº‹ä»¶ç³»ç»ŸéªŒè¯å®Œæˆ: ${testsPassed}/${totalTests} æµ‹è¯•é€šè¿‡`, 'success');
            } else {
                log(`âš ï¸ äº‹ä»¶ç³»ç»ŸéªŒè¯å®Œæˆ: ${testsPassed}/${totalTests} æµ‹è¯•é€šè¿‡`, 'warning');
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('testLog').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ä¸ªäººä¸­å¿ƒæ•°æ®åŒæ­¥æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('è¯·å…ˆç‚¹å‡»"åˆ·æ–°å½“å‰æ•°æ®"æŸ¥çœ‹å½“å‰çŠ¶æ€');
            updateListenerStatus('æœªå¯åŠ¨', 'info');
            
            // è‡ªåŠ¨åŠ è½½å½“å‰æ•°æ®
            setTimeout(() => {
                loadCurrentData();
            }, 500);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (isListening) {
                stopEventListener();
            }
        });
    </script>
</body>
</html>