<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ å®Œæ•´æµç¨‹æµ‹è¯• - ç»éªŒå€¼æ›´æ–°éªŒè¯</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f7fafc;
        }
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
        }
        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .button.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        .button.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.4;
        }
        .success { background: #f0fff4; border: 1px solid #9ae6b4; color: #22543d; }
        .error { background: #fed7d7; border: 1px solid #fc8181; color: #742a2a; }
        .info { background: #ebf8ff; border: 1px solid #90cdf4; color: #2a4365; }
        .warning { background: #fef5e7; border: 1px solid #f6ad55; color: #744210; }
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .data-card {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .data-card h4 {
            margin: 0 0 10px 0;
            color: #4a5568;
            font-size: 14px;
        }
        .data-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        .data-change {
            font-size: 12px;
            margin-top: 5px;
        }
        .positive { color: #38a169; }
        .negative { color: #e53e3e; }
        .neutral { color: #718096; }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #edf2f7;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .step.completed {
            border-left-color: #38a169;
            background: #f0fff4;
        }
        .step.failed {
            border-left-color: #e53e3e;
            background: #fed7d7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ å®Œæ•´æµç¨‹æµ‹è¯• - ç»éªŒå€¼æ›´æ–°éªŒè¯</h1>
        
        <!-- å½“å‰çŠ¶æ€ -->
        <div class="test-section">
            <h3>ğŸ“Š å½“å‰ç”¨æˆ·æ•°æ®</h3>
            <div class="data-grid">
                <div class="data-card">
                    <h4>ç­‰çº§</h4>
                    <div class="data-value" id="current-level">-</div>
                    <div class="data-change neutral" id="level-change">æœªæ›´æ–°</div>
                </div>
                <div class="data-card">
                    <h4>ç»éªŒå€¼</h4>
                    <div class="data-value" id="current-experience">-</div>
                    <div class="data-change neutral" id="experience-change">æœªæ›´æ–°</div>
                </div>
                <div class="data-card">
                    <h4>æ€»åˆ†</h4>
                    <div class="data-value" id="current-score">-</div>
                    <div class="data-change neutral" id="score-change">æœªæ›´æ–°</div>
                </div>
            </div>
            <button class="button" onclick="refreshData()">åˆ·æ–°æ•°æ®</button>
            <button class="button warning" onclick="resetChanges()">é‡ç½®å˜åŒ–</button>
        </div>

        <!-- å®Œæ•´æµç¨‹æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸš€ å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <div style="margin-bottom: 15px;">
                <button class="button success" onclick="runCompleteTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                <button class="button" onclick="testQuizFlow()">æµ‹éªŒæµç¨‹</button>
                <button class="button" onclick="testChapterFlow()">ç« èŠ‚æµç¨‹</button>
            </div>
            <div id="flow-steps"></div>
            <div id="flow-result" class="result" style="display:none;"></div>
        </div>

        <!-- äº‹ä»¶ç›‘å¬éªŒè¯ -->
        <div class="test-section">
            <h3>ğŸ“¡ äº‹ä»¶ç›‘å¬éªŒè¯</h3>
            <div style="margin-bottom: 15px;">
                <button class="button" onclick="startEventMonitoring()">å¼€å§‹ç›‘å¬</button>
                <button class="button warning" onclick="stopEventMonitoring()">åœæ­¢ç›‘å¬</button>
                <button class="button" onclick="triggerTestEvent()">è§¦å‘æµ‹è¯•äº‹ä»¶</button>
            </div>
            <div id="event-result" class="result" style="display:none;"></div>
        </div>

        <!-- é—®é¢˜è¯Šæ–­ -->
        <div class="test-section">
            <h3>ğŸ” é—®é¢˜è¯Šæ–­</h3>
            <div style="margin-bottom: 15px;">
                <button class="button" onclick="diagnoseIssues()">è¯Šæ–­é—®é¢˜</button>
                <button class="button" onclick="checkAPIEndpoints()">æ£€æŸ¥API</button>
                <button class="button" onclick="validateEventSystem()">éªŒè¯äº‹ä»¶ç³»ç»Ÿ</button>
            </div>
            <div id="diagnosis-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8082';
        let userData = { level: 0, experience: 0, totalScore: 0 };
        let previousData = { level: 0, experience: 0, totalScore: 0 };
        let isMonitoring = false;
        let eventListener = null;
        let eventCount = 0;

        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        function updateDataDisplay() {
            document.getElementById('current-level').textContent = userData.level;
            document.getElementById('current-experience').textContent = userData.experience;
            document.getElementById('current-score').textContent = userData.totalScore;
            
            // æ›´æ–°å˜åŒ–æ˜¾ç¤º
            updateChangeDisplay('level-change', userData.level, previousData.level);
            updateChangeDisplay('experience-change', userData.experience, previousData.experience);
            updateChangeDisplay('score-change', userData.totalScore, previousData.totalScore);
        }

        function updateChangeDisplay(elementId, current, previous) {
            const element = document.getElementById(elementId);
            const diff = current - previous;
            
            if (diff > 0) {
                element.textContent = `+${diff}`;
                element.className = 'data-change positive';
            } else if (diff < 0) {
                element.textContent = `${diff}`;
                element.className = 'data-change negative';
            } else {
                element.textContent = 'æ— å˜åŒ–';
                element.className = 'data-change neutral';
            }
        }

        async function refreshData() {
            try {
                const response = await fetch(`${API_BASE}/api/level/stats`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.code === 200) {
                        userData = result.data;
                        updateDataDisplay();
                        return true;
                    }
                }
                throw new Error('è·å–æ•°æ®å¤±è´¥');
            } catch (error) {
                // åˆ·æ–°æ•°æ®å¤±è´¥
                return false;
            }
        }

        function resetChanges() {
            previousData = { ...userData };
            updateDataDisplay();
        }

        function addStep(container, text, status = 'pending') {
            const step = document.createElement('div');
            step.className = `step ${status}`;
            step.innerHTML = `${status === 'completed' ? 'âœ…' : status === 'failed' ? 'âŒ' : 'â³'} ${text}`;
            container.appendChild(step);
            return step;
        }

        async function runCompleteTest() {
            const container = document.getElementById('flow-steps');
            container.innerHTML = '';
            
            let message = '=== ğŸ¯ å®Œæ•´æµç¨‹æµ‹è¯•å¼€å§‹ ===\n\n';
            showResult('flow-result', message, 'info');
            
            // æ­¥éª¤1: è·å–åˆå§‹æ•°æ®
            const step1 = addStep(container, 'è·å–åˆå§‹ç”¨æˆ·æ•°æ®');
            const dataSuccess = await refreshData();
            if (dataSuccess) {
                step1.className = 'step completed';
                step1.innerHTML = 'âœ… è·å–åˆå§‹ç”¨æˆ·æ•°æ®';
                previousData = { ...userData };
                message += `ğŸ“Š åˆå§‹æ•°æ®: ç­‰çº§${userData.level}, ç»éªŒå€¼${userData.experience}, æ€»åˆ†${userData.totalScore}\n`;
            } else {
                step1.className = 'step failed';
                step1.innerHTML = 'âŒ è·å–åˆå§‹ç”¨æˆ·æ•°æ®å¤±è´¥';
                message += 'âŒ æ— æ³•è·å–åˆå§‹æ•°æ®ï¼Œæµ‹è¯•ç»ˆæ­¢\n';
                showResult('flow-result', message, 'error');
                return;
            }
            
            // æ­¥éª¤2: è°ƒç”¨ç»éªŒå€¼API
            const step2 = addStep(container, 'è°ƒç”¨ç»éªŒå€¼æ·»åŠ API');
            try {
                const requestData = {
                    experience: 30,
                    activityType: 'complete_test',
                    chapterId: 1,
                    score: 85
                };
                
                const response = await fetch(`${API_BASE}/api/level/addExperience`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.code === 200) {
                    step2.className = 'step completed';
                    step2.innerHTML = 'âœ… è°ƒç”¨ç»éªŒå€¼æ·»åŠ APIæˆåŠŸ';
                    message += `âœ… APIè°ƒç”¨æˆåŠŸï¼Œæ–°ç»éªŒå€¼: ${result.data.experience}\n`;
                    
                    // æ­¥éª¤3: è§¦å‘äº‹ä»¶
                    const step3 = addStep(container, 'è§¦å‘experienceUpdatedäº‹ä»¶');
                    const eventData = {
                        experienceGained: 30,
                        newExperience: result.data.experience,
                        newLevel: result.data.newLevel,
                        leveledUp: result.data.levelUp
                    };
                    
                    window.dispatchEvent(new CustomEvent('experienceUpdated', {
                        detail: eventData
                    }));
                    
                    step3.className = 'step completed';
                    step3.innerHTML = 'âœ… è§¦å‘experienceUpdatedäº‹ä»¶';
                    message += `ğŸ“¡ äº‹ä»¶å·²è§¦å‘ï¼Œæ•°æ®: ${JSON.stringify(eventData)}\n`;
                    
                    // æ­¥éª¤4: ç­‰å¾…å¹¶éªŒè¯æ•°æ®æ›´æ–°
                    const step4 = addStep(container, 'ç­‰å¾…æ•°æ®æ›´æ–°å¹¶éªŒè¯');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const updateSuccess = await refreshData();
                    if (updateSuccess) {
                        const expDiff = userData.experience - previousData.experience;
                        const scoreDiff = userData.totalScore - previousData.totalScore;
                        
                        if (expDiff > 0 || scoreDiff > 0) {
                            step4.className = 'step completed';
                            step4.innerHTML = 'âœ… æ•°æ®æ›´æ–°éªŒè¯æˆåŠŸ';
                            message += `ğŸ‰ æµ‹è¯•æˆåŠŸï¼ç»éªŒå€¼å˜åŒ–: +${expDiff}, æ€»åˆ†å˜åŒ–: +${scoreDiff}\n`;
                            message += `\n=== æœ€ç»ˆç»“æœ ===\n`;
                            message += `âœ… APIè°ƒç”¨æ­£å¸¸\n`;
                            message += `âœ… äº‹ä»¶è§¦å‘æ­£å¸¸\n`;
                            message += `âœ… æ•°æ®æ›´æ–°æ­£å¸¸\n`;
                            message += `\nğŸ¯ ç»éªŒå€¼æ›´æ–°æµç¨‹å®Œå…¨æ­£å¸¸ï¼`;
                            showResult('flow-result', message, 'success');
                        } else {
                            step4.className = 'step failed';
                            step4.innerHTML = 'âŒ æ•°æ®æœªæ›´æ–°';
                            message += `âš ï¸ æ•°æ®æœªå‘ç”Ÿå˜åŒ–ï¼Œå¯èƒ½å­˜åœ¨ç¼“å­˜æˆ–åŒæ­¥é—®é¢˜\n`;
                            showResult('flow-result', message, 'warning');
                        }
                    } else {
                        step4.className = 'step failed';
                        step4.innerHTML = 'âŒ æ— æ³•éªŒè¯æ•°æ®æ›´æ–°';
                        message += `âŒ æ— æ³•è·å–æ›´æ–°åçš„æ•°æ®\n`;
                        showResult('flow-result', message, 'error');
                    }
                } else {
                    step2.className = 'step failed';
                    step2.innerHTML = 'âŒ è°ƒç”¨ç»éªŒå€¼æ·»åŠ APIå¤±è´¥';
                    message += `âŒ APIè°ƒç”¨å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}\n`;
                    showResult('flow-result', message, 'error');
                }
            } catch (error) {
                step2.className = 'step failed';
                step2.innerHTML = 'âŒ è°ƒç”¨ç»éªŒå€¼æ·»åŠ APIå¼‚å¸¸';
                message += `âŒ APIè°ƒç”¨å¼‚å¸¸: ${error.message}\n`;
                showResult('flow-result', message, 'error');
            }
        }

        async function testQuizFlow() {
            const container = document.getElementById('flow-steps');
            container.innerHTML = '';
            
            addStep(container, 'æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆæµç¨‹', 'pending');
            
            // æ¨¡æ‹ŸQuizSystemçš„é€»è¾‘
            await refreshData();
            previousData = { ...userData };
            
            try {
                const score = 90;
                const experience = score + 15; // åˆ†æ•° + å¥–åŠ±
                
                const response = await fetch(`${API_BASE}/api/level/addExperience`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        experience: experience,
                        activityType: 'quiz_completion',
                        chapterId: 1,
                        score: score
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.code === 200) {
                    // è§¦å‘äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('experienceUpdated', {
                        detail: {
                            experienceGained: experience,
                            newExperience: result.data.experience,
                            newLevel: result.data.newLevel,
                            leveledUp: result.data.levelUp
                        }
                    }));
                    
                    container.children[0].className = 'step completed';
                    container.children[0].innerHTML = 'âœ… æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆæµç¨‹æˆåŠŸ';
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    await refreshData();
                    
                    const message = `ğŸ¯ æµ‹éªŒæµç¨‹æµ‹è¯•å®Œæˆ\nå¾—åˆ†: ${score}\nç»éªŒå€¼å˜åŒ–: +${userData.experience - previousData.experience}\næ€»åˆ†å˜åŒ–: +${userData.totalScore - previousData.totalScore}`;
                    showResult('flow-result', message, 'success');
                } else {
                    container.children[0].className = 'step failed';
                    container.children[0].innerHTML = 'âŒ æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆæµç¨‹å¤±è´¥';
                    showResult('flow-result', `âŒ æµ‹éªŒæµç¨‹å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                container.children[0].className = 'step failed';
                container.children[0].innerHTML = 'âŒ æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆæµç¨‹å¼‚å¸¸';
                showResult('flow-result', `âŒ æµ‹éªŒæµç¨‹å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testChapterFlow() {
            const container = document.getElementById('flow-steps');
            container.innerHTML = '';
            
            addStep(container, 'æ¨¡æ‹Ÿç« èŠ‚å®Œæˆæµç¨‹', 'pending');
            
            await refreshData();
            previousData = { ...userData };
            
            try {
                const response = await fetch(`${API_BASE}/api/level/addExperience`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        experience: 50,
                        activityType: 'chapter',
                        chapterId: 2,
                        score: 100
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.code === 200) {
                    window.dispatchEvent(new CustomEvent('experienceUpdated', {
                        detail: {
                            experienceGained: 50,
                            newExperience: result.data.experience,
                            newLevel: result.data.newLevel,
                            leveledUp: result.data.levelUp
                        }
                    }));
                    
                    container.children[0].className = 'step completed';
                    container.children[0].innerHTML = 'âœ… æ¨¡æ‹Ÿç« èŠ‚å®Œæˆæµç¨‹æˆåŠŸ';
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    await refreshData();
                    
                    const message = `ğŸ“š ç« èŠ‚æµç¨‹æµ‹è¯•å®Œæˆ\nç« èŠ‚: ç¬¬2ç« \nç»éªŒå€¼å˜åŒ–: +${userData.experience - previousData.experience}`;
                    showResult('flow-result', message, 'success');
                } else {
                    container.children[0].className = 'step failed';
                    container.children[0].innerHTML = 'âŒ æ¨¡æ‹Ÿç« èŠ‚å®Œæˆæµç¨‹å¤±è´¥';
                    showResult('flow-result', `âŒ ç« èŠ‚æµç¨‹å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                container.children[0].className = 'step failed';
                container.children[0].innerHTML = 'âŒ æ¨¡æ‹Ÿç« èŠ‚å®Œæˆæµç¨‹å¼‚å¸¸';
                showResult('flow-result', `âŒ ç« èŠ‚æµç¨‹å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        function startEventMonitoring() {
            if (isMonitoring) {
                showResult('event-result', 'âš ï¸ å·²åœ¨ç›‘å¬äº‹ä»¶', 'warning');
                return;
            }
            
            isMonitoring = true;
            eventCount = 0;
            let message = 'ğŸ” å¼€å§‹ç›‘å¬experienceUpdatedäº‹ä»¶...\n\n';
            
            eventListener = (event) => {
                eventCount++;
                const timestamp = new Date().toLocaleTimeString();
                message += `[${timestamp}] ğŸ“¡ æ”¶åˆ°ç¬¬${eventCount}ä¸ªäº‹ä»¶:\n`;
                message += `${JSON.stringify(event.detail, null, 2)}\n\n`;
                showResult('event-result', message, 'success');
            };
            
            window.addEventListener('experienceUpdated', eventListener);
            showResult('event-result', message, 'info');
        }

        function stopEventMonitoring() {
            if (!isMonitoring) {
                showResult('event-result', 'âš ï¸ æœªåœ¨ç›‘å¬äº‹ä»¶', 'warning');
                return;
            }
            
            isMonitoring = false;
            if (eventListener) {
                window.removeEventListener('experienceUpdated', eventListener);
                eventListener = null;
            }
            
            const message = `ğŸ›‘ åœæ­¢äº‹ä»¶ç›‘å¬\n\nğŸ“Š ç›‘å¬ç»Ÿè®¡:\n- æ€»äº‹ä»¶æ•°: ${eventCount}`;
            showResult('event-result', message, 'info');
        }

        function triggerTestEvent() {
            const eventData = {
                experienceGained: 25,
                newExperience: (userData.experience || 0) + 25,
                newLevel: userData.level || 1,
                leveledUp: false,
                source: 'manual_test'
            };
            
            window.dispatchEvent(new CustomEvent('experienceUpdated', {
                detail: eventData
            }));
            
            if (!isMonitoring) {
                showResult('event-result', 'ğŸ“¤ å·²è§¦å‘æµ‹è¯•äº‹ä»¶ï¼ˆè¯·å…ˆå¼€å§‹ç›‘å¬ä»¥æŸ¥çœ‹ç»“æœï¼‰', 'info');
            }
        }

        async function diagnoseIssues() {
            let message = '=== ğŸ” é—®é¢˜è¯Šæ–­æŠ¥å‘Š ===\n\n';
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('token');
            if (!token || token === 'null') {
                message += 'âŒ ç”¨æˆ·æœªç™»å½•æˆ–tokenæ— æ•ˆ\n';
            } else {
                message += 'âœ… ç”¨æˆ·å·²ç™»å½•\n';
            }
            
            // æ£€æŸ¥APIè¿æ¥
            try {
                const response = await fetch(`${API_BASE}/api/level/stats`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    message += 'âœ… APIè¿æ¥æ­£å¸¸\n';
                } else {
                    message += `âŒ APIè¿æ¥å¼‚å¸¸: ${response.status}\n`;
                }
            } catch (error) {
                message += `âŒ APIè¿æ¥å¤±è´¥: ${error.message}\n`;
            }
            
            // æ£€æŸ¥äº‹ä»¶ç³»ç»Ÿ
            let eventReceived = false;
            const testListener = () => { eventReceived = true; };
            window.addEventListener('experienceUpdated', testListener);
            
            window.dispatchEvent(new CustomEvent('experienceUpdated', {
                detail: { test: true }
            }));
            
            setTimeout(() => {
                window.removeEventListener('experienceUpdated', testListener);
                if (eventReceived) {
                    message += 'âœ… äº‹ä»¶ç³»ç»Ÿæ­£å¸¸\n';
                } else {
                    message += 'âŒ äº‹ä»¶ç³»ç»Ÿå¼‚å¸¸\n';
                }
                
                message += '\n=== è¯Šæ–­å®Œæˆ ===';
                showResult('diagnosis-result', message, eventReceived ? 'success' : 'warning');
            }, 100);
        }

        async function checkAPIEndpoints() {
            let message = '=== ğŸ”— APIç«¯ç‚¹æ£€æŸ¥ ===\n\n';
            
            const endpoints = [
                { name: 'ç”¨æˆ·ä¿¡æ¯', url: '/api/users/userInfo', method: 'GET' },
                { name: 'ç”¨æˆ·ç»Ÿè®¡', url: '/api/level/stats', method: 'GET' },
                { name: 'æ·»åŠ ç»éªŒå€¼', url: '/api/level/addExperience', method: 'POST', body: { experience: 1, activityType: 'test', chapterId: 1, score: 1 } }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const options = {
                        method: endpoint.method,
                        headers: getAuthHeaders()
                    };
                    
                    if (endpoint.body) {
                        options.body = JSON.stringify(endpoint.body);
                    }
                    
                    const response = await fetch(`${API_BASE}${endpoint.url}`, options);
                    
                    if (response.ok) {
                        message += `âœ… ${endpoint.name}: æ­£å¸¸\n`;
                    } else {
                        message += `âŒ ${endpoint.name}: ${response.status}\n`;
                    }
                } catch (error) {
                    message += `âŒ ${endpoint.name}: ${error.message}\n`;
                }
            }
            
            showResult('diagnosis-result', message, 'info');
        }

        function validateEventSystem() {
            let message = '=== ğŸ“¡ äº‹ä»¶ç³»ç»ŸéªŒè¯ ===\n\n';
            let testsPassed = 0;
            const totalTests = 3;
            
            // æµ‹è¯•1: åŸºæœ¬äº‹ä»¶è§¦å‘å’Œç›‘å¬
            let test1Passed = false;
            const listener1 = (event) => {
                if (event.detail.test === 'basic') {
                    test1Passed = true;
                }
            };
            
            window.addEventListener('experienceUpdated', listener1);
            window.dispatchEvent(new CustomEvent('experienceUpdated', {
                detail: { test: 'basic' }
            }));
            
            setTimeout(() => {
                window.removeEventListener('experienceUpdated', listener1);
                if (test1Passed) {
                    message += 'âœ… åŸºæœ¬äº‹ä»¶è§¦å‘å’Œç›‘å¬: æ­£å¸¸\n';
                    testsPassed++;
                } else {
                    message += 'âŒ åŸºæœ¬äº‹ä»¶è§¦å‘å’Œç›‘å¬: å¼‚å¸¸\n';
                }
                
                // æµ‹è¯•2: äº‹ä»¶æ•°æ®ä¼ é€’
                let test2Passed = false;
                const listener2 = (event) => {
                    if (event.detail.experienceGained === 123 && event.detail.test === 'data') {
                        test2Passed = true;
                    }
                };
                
                window.addEventListener('experienceUpdated', listener2);
                window.dispatchEvent(new CustomEvent('experienceUpdated', {
                    detail: { test: 'data', experienceGained: 123, newLevel: 5 }
                }));
                
                setTimeout(() => {
                    window.removeEventListener('experienceUpdated', listener2);
                    if (test2Passed) {
                        message += 'âœ… äº‹ä»¶æ•°æ®ä¼ é€’: æ­£å¸¸\n';
                        testsPassed++;
                    } else {
                        message += 'âŒ äº‹ä»¶æ•°æ®ä¼ é€’: å¼‚å¸¸\n';
                    }
                    
                    // æµ‹è¯•3: å¤šç›‘å¬å™¨
                    let test3Count = 0;
                    const listener3a = () => { test3Count++; };
                    const listener3b = () => { test3Count++; };
                    
                    window.addEventListener('experienceUpdated', listener3a);
                    window.addEventListener('experienceUpdated', listener3b);
                    window.dispatchEvent(new CustomEvent('experienceUpdated', {
                        detail: { test: 'multiple' }
                    }));
                    
                    setTimeout(() => {
                        window.removeEventListener('experienceUpdated', listener3a);
                        window.removeEventListener('experienceUpdated', listener3b);
                        
                        if (test3Count === 2) {
                            message += 'âœ… å¤šç›‘å¬å™¨æ”¯æŒ: æ­£å¸¸\n';
                            testsPassed++;
                        } else {
                            message += 'âŒ å¤šç›‘å¬å™¨æ”¯æŒ: å¼‚å¸¸\n';
                        }
                        
                        message += `\n=== éªŒè¯ç»“æœ ===\n`;
                        message += `é€šè¿‡æµ‹è¯•: ${testsPassed}/${totalTests}\n`;
                        
                        if (testsPassed === totalTests) {
                            message += 'ğŸ‰ äº‹ä»¶ç³»ç»Ÿå®Œå…¨æ­£å¸¸ï¼';
                            showResult('diagnosis-result', message, 'success');
                        } else {
                            message += 'âš ï¸ äº‹ä»¶ç³»ç»Ÿå­˜åœ¨é—®é¢˜';
                            showResult('diagnosis-result', message, 'warning');
                        }
                    }, 100);
                }, 100);
            }, 100);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®
        window.onload = function() {
            refreshData();
        };
    </script>
</body>
</html>