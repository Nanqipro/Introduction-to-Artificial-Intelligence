<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç« èŠ‚å®ŒæˆåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #4a5568;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
        }
        .test-section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .test-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        .success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        .error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        .info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        .login-section {
            background: #fff5f5;
            border: 2px solid #feb2b2;
        }
        .login-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .login-form input {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .status-display {
            margin: 20px 0;
            padding: 15px;
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
        }
        .chapter-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .chapter-item {
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }
        .chapter-item h3 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }
        .chapter-item p {
            margin: 5px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ç« èŠ‚å®ŒæˆåŠŸèƒ½æµ‹è¯•</h1>
        
        <!-- ç™»å½•çŠ¶æ€ -->
        <div class="test-section login-section">
            <h2>ğŸ” ç™»å½•çŠ¶æ€</h2>
            <div class="login-form">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="testuser">
                <input type="password" id="password" placeholder="å¯†ç " value="123456">
                <button class="test-button" onclick="login()">ç™»å½•</button>
                <button class="test-button" onclick="logout()">ç™»å‡º</button>
                <button class="test-button" onclick="checkLoginStatus()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
            </div>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
        <div class="status-display">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <div id="currentStatus">ç‚¹å‡»"æ£€æŸ¥ç™»å½•çŠ¶æ€"æŸ¥çœ‹å½“å‰çŠ¶æ€</div>
        </div>

        <!-- åºç« è§†é¢‘å®Œæˆæµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ¬ åºç« è§†é¢‘å®Œæˆæµ‹è¯•</h2>
            <p>æµ‹è¯•åºç« è§†é¢‘è§‚çœ‹å®Œæˆåçš„ç« èŠ‚å®Œæˆé€»è¾‘</p>
            <button class="test-button" onclick="testPrologueCompletion()">æ¨¡æ‹Ÿåºç« è§†é¢‘å®Œæˆ</button>
            <button class="test-button" onclick="checkPrologueStatus()">æ£€æŸ¥åºç« å®ŒæˆçŠ¶æ€</button>
            <div id="prologueResult" class="result" style="display: none;"></div>
        </div>

        <!-- æµ‹éªŒå®Œæˆæµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ“ æµ‹éªŒå®Œæˆæµ‹è¯•</h2>
            <p>æµ‹è¯•å„ç« èŠ‚æµ‹éªŒå®Œæˆåçš„ç« èŠ‚å®Œæˆé€»è¾‘</p>
            <div>
                <label>é€‰æ‹©ç« èŠ‚: </label>
                <select id="chapterSelect">
                    <option value="1">ç¬¬1ç« </option>
                    <option value="2">ç¬¬2ç« </option>
                    <option value="3">ç¬¬3ç« </option>
                    <option value="4">ç¬¬4ç« </option>
                    <option value="5">ç¬¬5ç« </option>
                    <option value="6">ç¬¬6ç« </option>
                    <option value="7">ç¬¬7ç« </option>
                </select>
                <input type="number" id="quizScore" placeholder="æµ‹éªŒåˆ†æ•°" value="85" min="0" max="100">
                <button class="test-button" onclick="testQuizCompletion()">æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ</button>
            </div>
            <div id="quizResult" class="result" style="display: none;"></div>
        </div>

        <!-- ç« èŠ‚å®ŒæˆçŠ¶æ€æŸ¥è¯¢ -->
        <div class="test-section">
            <h2>ğŸ“‹ ç« èŠ‚å®ŒæˆçŠ¶æ€æŸ¥è¯¢</h2>
            <button class="test-button" onclick="getUserStats()">è·å–ç”¨æˆ·ç»Ÿè®¡</button>
            <button class="test-button" onclick="getLearningRecords()">è·å–å­¦ä¹ è®°å½•</button>
            <div id="statsResult" class="result" style="display: none;"></div>
        </div>

        <!-- ç»éªŒå€¼éªŒè¯ -->
        <div class="test-section">
            <h2>â­ ç»éªŒå€¼éªŒè¯</h2>
            <button class="test-button" onclick="checkExperienceRewards()">æ£€æŸ¥ç»éªŒå€¼å¥–åŠ±</button>
            <div id="experienceResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8082';
        let currentToken = localStorage.getItem('token');

        // é€šç”¨APIè°ƒç”¨å‡½æ•°
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (currentToken) {
                options.headers.Authorization = currentToken.startsWith('Bearer ') ? currentToken : `Bearer ${currentToken}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                return result;
            } catch (error) {
                // APIè°ƒç”¨å¤±è´¥
                return { code: 500, message: 'ç½‘ç»œé”™è¯¯: ' + error.message };
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // ç™»å½•
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const result = await apiCall('/user/login', 'POST', { username, password });
            
            if (result.code === 200) {
                currentToken = result.data.token;
                localStorage.setItem('token', currentToken);
                showResult('loginResult', `ç™»å½•æˆåŠŸï¼Token: ${currentToken.substring(0, 20)}...`, 'success');
                checkLoginStatus();
            } else {
                showResult('loginResult', `ç™»å½•å¤±è´¥: ${result.message}`, 'error');
            }
        }

        // ç™»å‡º
        function logout() {
            currentToken = null;
            localStorage.removeItem('token');
            showResult('loginResult', 'å·²ç™»å‡º', 'info');
            document.getElementById('currentStatus').textContent = 'æœªç™»å½•';
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            if (!currentToken) {
                document.getElementById('currentStatus').textContent = 'æœªç™»å½•';
                return;
            }

            const result = await apiCall('/user/userInfo');
            if (result.code === 200) {
                const user = result.data;
                document.getElementById('currentStatus').innerHTML = `
                    <strong>å·²ç™»å½•ç”¨æˆ·:</strong> ${user.username}<br>
                    <strong>ç­‰çº§:</strong> ${user.level}<br>
                    <strong>ç»éªŒå€¼:</strong> ${user.experience}<br>
                    <strong>å­¦ä¹ æ—¶é•¿:</strong> ${user.studyTime || 0} åˆ†é’Ÿ
                `;
            } else {
                document.getElementById('currentStatus').textContent = 'ç™»å½•çŠ¶æ€å¼‚å¸¸: ' + result.message;
            }
        }

        // æµ‹è¯•åºç« å®Œæˆ
        async function testPrologueCompletion() {
            if (!currentToken) {
                showResult('prologueResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const result = await apiCall('/api/level/completeChapter', 'POST', {
                chapterId: 0,
                completionType: 'video',
                score: 100
            });

            if (result.code === 200) {
                showResult('prologueResult', `åºç« å®ŒæˆæˆåŠŸï¼è·å¾—ç»éªŒå€¼: ${JSON.stringify(result.data)}`, 'success');
                checkLoginStatus(); // åˆ·æ–°çŠ¶æ€
            } else {
                showResult('prologueResult', `åºç« å®Œæˆå¤±è´¥: ${result.message}`, 'error');
            }
        }

        // æ£€æŸ¥åºç« çŠ¶æ€
        async function checkPrologueStatus() {
            if (!currentToken) {
                showResult('prologueResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const result = await apiCall('/api/level/records');
            if (result.code === 200) {
                const prologueRecords = result.data.filter(record => 
                    record.chapterId === 0 && record.activityType === 'chapter'
                );
                showResult('prologueResult', 
                    `åºç« å®Œæˆè®°å½•: ${prologueRecords.length > 0 ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'} (${prologueRecords.length}æ¡è®°å½•)`, 
                    prologueRecords.length > 0 ? 'success' : 'info'
                );
            } else {
                showResult('prologueResult', `æŸ¥è¯¢å¤±è´¥: ${result.message}`, 'error');
            }
        }

        // æµ‹è¯•æµ‹éªŒå®Œæˆ
        async function testQuizCompletion() {
            if (!currentToken) {
                showResult('quizResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const chapterId = parseInt(document.getElementById('chapterSelect').value);
            const score = parseInt(document.getElementById('quizScore').value);

            const result = await apiCall('/api/level/completeChapter', 'POST', {
                chapterId,
                completionType: 'quiz',
                score
            });

            if (result.code === 200) {
                showResult('quizResult', `ç¬¬${chapterId}ç« æµ‹éªŒå®ŒæˆæˆåŠŸï¼è·å¾—ç»éªŒå€¼: ${JSON.stringify(result.data)}`, 'success');
                checkLoginStatus(); // åˆ·æ–°çŠ¶æ€
            } else {
                showResult('quizResult', `ç¬¬${chapterId}ç« æµ‹éªŒå®Œæˆå¤±è´¥: ${result.message}`, 'error');
            }
        }

        // è·å–ç”¨æˆ·ç»Ÿè®¡
        async function getUserStats() {
            if (!currentToken) {
                showResult('statsResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const result = await apiCall('/api/level/stats');
            if (result.code === 200) {
                const stats = result.data;
                showResult('statsResult', `
                    ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯:
                    ç­‰çº§: ${stats.level}
                    ç»éªŒå€¼: ${stats.experience}
                    å·²å®Œæˆç« èŠ‚: ${stats.completedChapters}
                    å­¦ä¹ æ—¶é•¿: ${stats.studyTime} åˆ†é’Ÿ
                    æ€»å­¦ä¹ æ¬¡æ•°: ${stats.totalLearningCount}
                `, 'success');
            } else {
                showResult('statsResult', `è·å–ç»Ÿè®¡å¤±è´¥: ${result.message}`, 'error');
            }
        }

        // è·å–å­¦ä¹ è®°å½•
        async function getLearningRecords() {
            if (!currentToken) {
                showResult('statsResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const result = await apiCall('/api/level/records');
            if (result.code === 200) {
                const records = result.data;
                const chapterRecords = records.filter(r => r.activityType === 'chapter');
                const recordsByChapter = {};
                
                chapterRecords.forEach(record => {
                    if (!recordsByChapter[record.chapterId]) {
                        recordsByChapter[record.chapterId] = [];
                    }
                    recordsByChapter[record.chapterId].push(record);
                });

                let message = `å­¦ä¹ è®°å½• (å…±${records.length}æ¡ï¼Œç« èŠ‚å®Œæˆ${chapterRecords.length}æ¡):\n`;
                Object.keys(recordsByChapter).forEach(chapterId => {
                    const chapterName = chapterId === '0' ? 'åºç« ' : `ç¬¬${chapterId}ç« `;
                    message += `${chapterName}: ${recordsByChapter[chapterId].length}æ¬¡å®Œæˆ\n`;
                });

                showResult('statsResult', message, 'success');
            } else {
                showResult('statsResult', `è·å–å­¦ä¹ è®°å½•å¤±è´¥: ${result.message}`, 'error');
            }
        }

        // æ£€æŸ¥ç»éªŒå€¼å¥–åŠ±
        async function checkExperienceRewards() {
            if (!currentToken) {
                showResult('experienceResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            // è·å–å½“å‰ç»éªŒå€¼
            const beforeResult = await apiCall('/user/userInfo');
            if (beforeResult.code !== 200) {
                showResult('experienceResult', 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
                return;
            }

            const beforeExp = beforeResult.data.experience;

            // æ¨¡æ‹Ÿå®Œæˆä¸€ä¸ªç« èŠ‚
            const completeResult = await apiCall('/api/level/completeChapter', 'POST', {
                chapterId: 1,
                completionType: 'quiz',
                score: 90
            });

            if (completeResult.code === 200) {
                // å†æ¬¡è·å–ç»éªŒå€¼
                const afterResult = await apiCall('/user/userInfo');
                if (afterResult.code === 200) {
                    const afterExp = afterResult.data.experience;
                    const gained = afterExp - beforeExp;
                    showResult('experienceResult', 
                        `ç»éªŒå€¼éªŒè¯æˆåŠŸï¼\nå®Œæˆå‰: ${beforeExp}\nå®Œæˆå: ${afterExp}\nè·å¾—: ${gained}`, 
                        'success'
                    );
                } else {
                    showResult('experienceResult', 'è·å–å®Œæˆåç»éªŒå€¼å¤±è´¥', 'error');
                }
            } else {
                showResult('experienceResult', `ç« èŠ‚å®Œæˆå¤±è´¥: ${completeResult.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            checkLoginStatus();
        };
    </script>
</body>
</html>