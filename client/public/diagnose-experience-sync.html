<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ç»éªŒå€¼åŒæ­¥é—®é¢˜è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: #f8f9fa;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .button.success {
            background: linear-gradient(135deg, #00b894, #00a085);
        }
        
        .button.warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #fd79a8, #e84393);
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-item {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            background: white;
        }
        
        .status-item h4 {
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 0 20px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: 1;
        }
        
        .step:last-child::after {
            display: none;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #dee2e6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            position: relative;
            z-index: 2;
            font-weight: bold;
            font-size: 12px;
        }
        
        .step.active .step-circle {
            background: #007bff;
        }
        
        .step.completed .step-circle {
            background: #28a745;
        }
        
        .step.failed .step-circle {
            background: #dc3545;
        }
        
        .step-label {
            font-size: 12px;
            color: #6c757d;
        }
        
        .iframe-container {
            margin-top: 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ç»éªŒå€¼åŒæ­¥é—®é¢˜è¯Šæ–­å·¥å…·</h1>
            <p>ä¸“é—¨ç”¨äºè¯Šæ–­å’Œè§£å†³ç¬¬1ç« æµ‹éªŒå®Œæˆåä¸ªäººä¸­å¿ƒç»éªŒå€¼ä¸åŒæ­¥çš„é—®é¢˜</p>
        </div>
        
        <div class="content">
            <!-- é—®é¢˜æè¿° -->
            <div class="section">
                <h3>ğŸ¯ é—®é¢˜æè¿°</h3>
                <p><strong>ç°è±¡ï¼š</strong>åœ¨ç¬¬1ç« å®Œæˆæµ‹éªŒå¹¶è·å¾—35åˆ†åï¼Œä¸ªäººä¸­å¿ƒçš„ç»éªŒå€¼ä»æ˜¾ç¤ºä¸º0ï¼Œæ²¡æœ‰è¿›è¡ŒåŒæ­¥æ›´æ–°ã€‚</p>
                <p><strong>é¢„æœŸï¼š</strong>æµ‹éªŒå®Œæˆåï¼Œä¸ªäººä¸­å¿ƒåº”è¯¥æ˜¾ç¤ºæ–°å¢çš„ç»éªŒå€¼ã€‚</p>
            </div>
            
            <!-- è¯Šæ–­æ­¥éª¤ -->
            <div class="section">
                <h3>ğŸ” è¯Šæ–­æ­¥éª¤</h3>
                <div class="step-indicator">
                    <div class="step" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">æ£€æŸ¥ç™»å½•çŠ¶æ€</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">è·å–å½“å‰æ•°æ®</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">éªŒè¯äº‹ä»¶è§¦å‘</div>
                    </div>
                    <div class="step" id="step5">
                        <div class="step-circle">5</div>
                        <div class="step-label">æ£€æŸ¥æ•°æ®æ›´æ–°</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="button success" onclick="startDiagnosis()">ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­</button>
                    <button class="button warning" onclick="resetDiagnosis()">ğŸ”„ é‡ç½®è¯Šæ–­</button>
                </div>
                
                <div id="diagnosis-result" class="result" style="display:none;"></div>
            </div>
            
            <!-- å½“å‰çŠ¶æ€æ£€æŸ¥ -->
            <div class="section">
                <h3>ğŸ“Š å½“å‰çŠ¶æ€æ£€æŸ¥</h3>
                <button class="button" onclick="checkCurrentStatus()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
                <button class="button" onclick="checkEventListeners()">æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨</button>
                <button class="button" onclick="testAPIConnection()">æµ‹è¯•APIè¿æ¥</button>
                
                <div class="status-grid" id="status-grid" style="display:none;">
                    <div class="status-item">
                        <h4>ç™»å½•çŠ¶æ€</h4>
                        <div class="status-value" id="login-status">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="status-item">
                        <h4>å½“å‰ç»éªŒå€¼</h4>
                        <div class="status-value" id="current-exp">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="status-item">
                        <h4>å½“å‰ç­‰çº§</h4>
                        <div class="status-value" id="current-level">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="status-item">
                        <h4>äº‹ä»¶ç›‘å¬å™¨</h4>
                        <div class="status-value" id="event-listeners">æ£€æŸ¥ä¸­...</div>
                    </div>
                </div>
                
                <div id="status-result" class="result" style="display:none;"></div>
            </div>
            
            <!-- æ‰‹åŠ¨æµ‹è¯• -->
            <div class="section">
                <h3>ğŸ§ª æ‰‹åŠ¨æµ‹è¯•</h3>
                <button class="button success" onclick="simulateQuizCompletion()">æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ (+35ç»éªŒ)</button>
                <button class="button success" onclick="triggerExperienceEvent()">æ‰‹åŠ¨è§¦å‘ç»éªŒå€¼äº‹ä»¶</button>
                <button class="button warning" onclick="refreshProfileData()">åˆ·æ–°ä¸ªäººä¸­å¿ƒæ•°æ®</button>
                
                <div id="manual-test-result" class="result" style="display:none;"></div>
            </div>
            
            <!-- è§£å†³æ–¹æ¡ˆ -->
            <div class="section">
                <h3>ğŸ”§ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ</h3>
                <div style="margin-bottom: 15px;">
                    <h4>å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ³•ï¼š</h4>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li><strong>APIè°ƒç”¨å¤±è´¥ï¼š</strong>æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡çŠ¶æ€</li>
                        <li><strong>äº‹ä»¶æœªè§¦å‘ï¼š</strong>ç¡®è®¤QuizSystemç»„ä»¶æ­£ç¡®è§¦å‘experienceUpdatedäº‹ä»¶</li>
                        <li><strong>äº‹ä»¶ç›‘å¬å¤±æ•ˆï¼š</strong>æ£€æŸ¥UserProfileç»„ä»¶çš„äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ­£å¸¸æ³¨å†Œ</li>
                        <li><strong>æ•°æ®ç¼“å­˜é—®é¢˜ï¼š</strong>å°è¯•åˆ·æ–°é¡µé¢æˆ–æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</li>
                        <li><strong>æƒé™é—®é¢˜ï¼š</strong>ç¡®è®¤ç”¨æˆ·å·²æ­£ç¡®ç™»å½•ä¸”tokenæœ‰æ•ˆ</li>
                    </ul>
                </div>
                
                <button class="button" onclick="applyQuickFix()">ğŸ”§ åº”ç”¨å¿«é€Ÿä¿®å¤</button>
                <button class="button warning" onclick="clearCacheAndRefresh()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°</button>
                
                <div id="solution-result" class="result" style="display:none;"></div>
            </div>
            
            <!-- ä¸ªäººä¸­å¿ƒé¢„è§ˆ -->
            <div class="section">
                <h3>ğŸ‘¤ ä¸ªäººä¸­å¿ƒå®æ—¶é¢„è§ˆ</h3>
                <p>åœ¨ä¸‹æ–¹iframeä¸­å¯ä»¥å®æ—¶æŸ¥çœ‹ä¸ªäººä¸­å¿ƒé¡µé¢çš„æ•°æ®å˜åŒ–ï¼š</p>
                <div class="iframe-container">
                    <iframe src="/profile" id="profile-iframe"></iframe>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8082';
        let diagnosisState = {
            step: 0,
            loginValid: false,
            baselineData: null,
            eventListenerActive: false
        };
        
        // è·å–è®¤è¯å¤´
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
        
        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        function updateStepIndicator(step, status) {
            const stepElement = document.getElementById(`step${step}`);
            stepElement.className = `step ${status}`;
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            if (!token || token.trim() === '' || token === 'null') {
                return false;
            }
            return true;
        }
        
        // å¼€å§‹å®Œæ•´è¯Šæ–­
        async function startDiagnosis() {
            let message = '=== å¼€å§‹ç»éªŒå€¼åŒæ­¥é—®é¢˜è¯Šæ–­ ===\n\n';
            
            try {
                // æ­¥éª¤1: æ£€æŸ¥ç™»å½•çŠ¶æ€
                updateStepIndicator(1, 'active');
                message += 'æ­¥éª¤1: æ£€æŸ¥ç™»å½•çŠ¶æ€...\n';
                
                if (!checkLoginStatus()) {
                    message += 'âŒ æœªç™»å½•æˆ–tokenæ— æ•ˆ\n';
                    updateStepIndicator(1, 'failed');
                    showResult('diagnosis-result', message, 'error');
                    return;
                }
                
                message += 'âœ… ç™»å½•çŠ¶æ€æ­£å¸¸\n\n';
                updateStepIndicator(1, 'completed');
                diagnosisState.loginValid = true;
                
                // æ­¥éª¤2: è·å–å½“å‰æ•°æ®
                updateStepIndicator(2, 'active');
                message += 'æ­¥éª¤2: è·å–å½“å‰ç”¨æˆ·æ•°æ®...\n';
                
                const statsResponse = await fetch(`${API_BASE}/api/level/stats`, {
                    headers: getAuthHeaders()
                });
                
                if (!statsResponse.ok) {
                    message += 'âŒ æ— æ³•è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®\n';
                    updateStepIndicator(2, 'failed');
                    showResult('diagnosis-result', message, 'error');
                    return;
                }
                
                const statsData = await statsResponse.json();
                diagnosisState.baselineData = statsData.data;
                
                message += `âœ… å½“å‰æ•°æ®è·å–æˆåŠŸ\n`;
                message += `   ç­‰çº§: ${statsData.data.level}\n`;
                message += `   ç»éªŒå€¼: ${statsData.data.experience}\n`;
                message += `   æ€»åˆ†: ${statsData.data.totalScore}\n\n`;
                updateStepIndicator(2, 'completed');
                
                // æ­¥éª¤3: æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ
                updateStepIndicator(3, 'active');
                message += 'æ­¥éª¤3: æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ...\n';
                
                const beforeExp = statsData.data.experience;
                const addExpResponse = await fetch(`${API_BASE}/api/level/addExperience`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        experience: 35,
                        activityType: 'quiz_completion',
                        chapterId: 1,
                        score: 35
                    })
                });
                
                if (!addExpResponse.ok) {
                    message += 'âŒ ç»éªŒå€¼æ·»åŠ APIè°ƒç”¨å¤±è´¥\n';
                    updateStepIndicator(3, 'failed');
                    showResult('diagnosis-result', message, 'error');
                    return;
                }
                
                const addExpData = await addExpResponse.json();
                if (addExpData.code !== 200) {
                    message += `âŒ ç»éªŒå€¼æ·»åŠ å¤±è´¥: ${addExpData.message}\n`;
                    updateStepIndicator(3, 'failed');
                    showResult('diagnosis-result', message, 'error');
                    return;
                }
                
                message += 'âœ… ç»éªŒå€¼æ·»åŠ æˆåŠŸ\n';
                message += `   æ–°ç»éªŒå€¼: ${addExpData.data.experience}\n`;
                message += `   ç»éªŒå€¼å¢åŠ : ${addExpData.data.experience - beforeExp}\n\n`;
                updateStepIndicator(3, 'completed');
                
                // æ­¥éª¤4: éªŒè¯äº‹ä»¶è§¦å‘
                updateStepIndicator(4, 'active');
                message += 'æ­¥éª¤4: è§¦å‘ç»éªŒå€¼æ›´æ–°äº‹ä»¶...\n';
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                let eventReceived = false;
                const eventHandler = (event) => {
                    eventReceived = true;
                    message += `âœ… æ”¶åˆ°experienceUpdatedäº‹ä»¶\n`;
                    message += `   äº‹ä»¶æ•°æ®: ${JSON.stringify(event.detail)}\n\n`;
                };
                
                window.addEventListener('experienceUpdated', eventHandler);
                
                // è§¦å‘äº‹ä»¶ï¼ˆæ¨¡æ‹ŸQuizSystemçš„è¡Œä¸ºï¼‰
                window.dispatchEvent(new CustomEvent('experienceUpdated', {
                    detail: {
                        experienceGained: 35,
                        newExperience: addExpData.data.experience,
                        newLevel: addExpData.data.newLevel,
                        leveledUp: addExpData.data.levelUp
                    }
                }));
                
                // ç­‰å¾…äº‹ä»¶å¤„ç†
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (eventReceived) {
                    message += 'âœ… äº‹ä»¶ç³»ç»Ÿå·¥ä½œæ­£å¸¸\n\n';
                    updateStepIndicator(4, 'completed');
                } else {
                    message += 'âš ï¸ äº‹ä»¶æœªè¢«æ¥æ”¶ï¼Œå¯èƒ½å­˜åœ¨ç›‘å¬å™¨é—®é¢˜\n\n';
                    updateStepIndicator(4, 'failed');
                }
                
                // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                window.removeEventListener('experienceUpdated', eventHandler);
                
                // æ­¥éª¤5: æ£€æŸ¥æ•°æ®æ›´æ–°
                updateStepIndicator(5, 'active');
                message += 'æ­¥éª¤5: éªŒè¯æ•°æ®æ›´æ–°...\n';
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´åå†æ¬¡è·å–æ•°æ®
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const finalStatsResponse = await fetch(`${API_BASE}/api/level/stats`, {
                    headers: getAuthHeaders()
                });
                
                if (finalStatsResponse.ok) {
                    const finalStatsData = await finalStatsResponse.json();
                    const expDiff = finalStatsData.data.experience - beforeExp;
                    
                    message += `âœ… æœ€ç»ˆæ•°æ®è·å–æˆåŠŸ\n`;
                    message += `   æœ€ç»ˆç»éªŒå€¼: ${finalStatsData.data.experience}\n`;
                    message += `   å®é™…å¢åŠ : ${expDiff}\n\n`;
                    
                    if (expDiff >= 35) {
                        message += 'ğŸ‰ è¯Šæ–­ç»“æœ: ç»éªŒå€¼åŒæ­¥æ­£å¸¸ï¼\n';
                        message += 'å¦‚æœä¸ªäººä¸­å¿ƒä»æ˜¾ç¤ºæ—§æ•°æ®ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢ã€‚';
                        updateStepIndicator(5, 'completed');
                        showResult('diagnosis-result', message, 'success');
                    } else {
                        message += 'âš ï¸ è¯Šæ–­ç»“æœ: ç»éªŒå€¼æœªæ­£ç¡®åŒæ­¥\n';
                        message += 'å»ºè®®æ£€æŸ¥åç«¯æ•°æ®åº“æˆ–APIå®ç°ã€‚';
                        updateStepIndicator(5, 'failed');
                        showResult('diagnosis-result', message, 'warning');
                    }
                } else {
                    message += 'âŒ æ— æ³•è·å–æœ€ç»ˆæ•°æ®\n';
                    updateStepIndicator(5, 'failed');
                    showResult('diagnosis-result', message, 'error');
                }
                
                // åˆ·æ–°ä¸ªäººä¸­å¿ƒiframe
                const iframe = document.getElementById('profile-iframe');
                iframe.src = iframe.src;
                
            } catch (error) {
                message += `âŒ è¯Šæ–­è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`;
                showResult('diagnosis-result', message, 'error');
            }
        }
        
        // é‡ç½®è¯Šæ–­
        function resetDiagnosis() {
            diagnosisState = {
                step: 0,
                loginValid: false,
                baselineData: null,
                eventListenerActive: false
            };
            
            for (let i = 1; i <= 5; i++) {
                updateStepIndicator(i, '');
            }
            
            document.getElementById('diagnosis-result').style.display = 'none';
            document.getElementById('status-grid').style.display = 'none';
            document.getElementById('status-result').style.display = 'none';
            document.getElementById('manual-test-result').style.display = 'none';
            document.getElementById('solution-result').style.display = 'none';
        }
        
        // æ£€æŸ¥å½“å‰çŠ¶æ€
        async function checkCurrentStatus() {
            document.getElementById('status-grid').style.display = 'grid';
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const loginStatus = checkLoginStatus();
            document.getElementById('login-status').textContent = loginStatus ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•';
            document.getElementById('login-status').style.color = loginStatus ? '#28a745' : '#dc3545';
            
            if (!loginStatus) {
                showResult('status-result', 'è¯·å…ˆç™»å½•åå†è¿›è¡Œæ£€æŸ¥', 'warning');
                return;
            }
            
            try {
                // è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®
                const response = await fetch(`${API_BASE}/api/level/stats`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('current-exp').textContent = data.data.experience;
                    document.getElementById('current-level').textContent = data.data.level;
                    
                    showResult('status-result', 'âœ… å½“å‰çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');
                } else {
                    document.getElementById('current-exp').textContent = 'è·å–å¤±è´¥';
                    document.getElementById('current-level').textContent = 'è·å–å¤±è´¥';
                    showResult('status-result', 'âŒ æ— æ³•è·å–ç”¨æˆ·æ•°æ®', 'error');
                }
            } catch (error) {
                showResult('status-result', `âŒ æ£€æŸ¥çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
        function checkEventListeners() {
            // è¿™é‡Œå¯ä»¥æ£€æŸ¥æ˜¯å¦æœ‰experienceUpdatedäº‹ä»¶ç›‘å¬å™¨
            // ç”±äºæ— æ³•ç›´æ¥æ£€æŸ¥ï¼Œæˆ‘ä»¬é€šè¿‡æµ‹è¯•äº‹ä»¶æ¥éªŒè¯
            let eventReceived = false;
            
            const testHandler = () => {
                eventReceived = true;
            };
            
            window.addEventListener('experienceUpdated', testHandler);
            
            // è§¦å‘æµ‹è¯•äº‹ä»¶
            window.dispatchEvent(new CustomEvent('experienceUpdated', {
                detail: { test: true }
            }));
            
            setTimeout(() => {
                window.removeEventListener('experienceUpdated', testHandler);
                
                const status = eventReceived ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸';
                document.getElementById('event-listeners').textContent = status;
                document.getElementById('event-listeners').style.color = eventReceived ? '#28a745' : '#dc3545';
                
                const message = eventReceived ? 
                    'âœ… äº‹ä»¶ç›‘å¬å™¨å·¥ä½œæ­£å¸¸' : 
                    'âš ï¸ äº‹ä»¶ç›‘å¬å™¨å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œå»ºè®®åˆ·æ–°é¡µé¢';
                showResult('status-result', message, eventReceived ? 'success' : 'warning');
            }, 100);
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testAPIConnection() {
            if (!checkLoginStatus()) {
                showResult('status-result', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/level/stats`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showResult('status-result', 'âœ… APIè¿æ¥æ­£å¸¸', 'success');
                } else {
                    showResult('status-result', `âŒ APIè¿æ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('status-result', `âŒ APIè¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        // æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ
        async function simulateQuizCompletion() {
            if (!checkLoginStatus()) {
                showResult('manual-test-result', 'âŒ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            let message = '=== æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ ===\n';
            
            try {
                // è·å–å½“å‰ç»éªŒå€¼
                const beforeResponse = await fetch(`${API_BASE}/api/level/stats`, {
                    headers: getAuthHeaders()
                });
                
                const beforeData = await beforeResponse.json();
                const beforeExp = beforeData.data.experience;
                
                message += `æµ‹éªŒå‰ç»éªŒå€¼: ${beforeExp}\n`;
                
                // æ·»åŠ ç»éªŒå€¼
                const addResponse = await fetch(`${API_BASE}/api/level/addExperience`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        experience: 35,
                        activityType: 'quiz_completion',
                        chapterId: 1,
                        score: 35
                    })
                });
                
                const addData = await addResponse.json();
                
                if (addResponse.ok && addData.code === 200) {
                    message += `âœ… ç»éªŒå€¼æ·»åŠ æˆåŠŸ\n`;
                    message += `æ–°ç»éªŒå€¼: ${addData.data.experience}\n`;
                    message += `å¢åŠ : ${addData.data.experience - beforeExp}\n\n`;
                    
                    // è§¦å‘äº‹ä»¶
                    message += 'è§¦å‘ç»éªŒå€¼æ›´æ–°äº‹ä»¶...\n';
                    window.dispatchEvent(new CustomEvent('experienceUpdated', {
                        detail: {
                            experienceGained: 35,
                            newExperience: addData.data.experience,
                            newLevel: addData.data.newLevel,
                            leveledUp: addData.data.levelUp
                        }
                    }));
                    
                    message += 'âœ… äº‹ä»¶å·²è§¦å‘\n';
                    message += 'è¯·æ£€æŸ¥ä¸ªäººä¸­å¿ƒé¡µé¢æ˜¯å¦æ›´æ–°';
                    
                    showResult('manual-test-result', message, 'success');
                    
                    // åˆ·æ–°ä¸ªäººä¸­å¿ƒiframe
                    setTimeout(() => {
                        const iframe = document.getElementById('profile-iframe');
                        iframe.src = iframe.src;
                    }, 1000);
                } else {
                    message += `âŒ ç»éªŒå€¼æ·»åŠ å¤±è´¥: ${addData.message}`;
                    showResult('manual-test-result', message, 'error');
                }
            } catch (error) {
                message += `âŒ æ¨¡æ‹Ÿæµ‹éªŒå¤±è´¥: ${error.message}`;
                showResult('manual-test-result', message, 'error');
            }
        }
        
        // æ‰‹åŠ¨è§¦å‘ç»éªŒå€¼äº‹ä»¶
        function triggerExperienceEvent() {
            const eventData = {
                experienceGained: 35,
                newExperience: 135,
                newLevel: 2,
                leveledUp: false
            };
            
            window.dispatchEvent(new CustomEvent('experienceUpdated', {
                detail: eventData
            }));
            
            showResult('manual-test-result', 
                `âœ… å·²æ‰‹åŠ¨è§¦å‘experienceUpdatedäº‹ä»¶\näº‹ä»¶æ•°æ®: ${JSON.stringify(eventData, null, 2)}`, 
                'success');
        }
        
        // åˆ·æ–°ä¸ªäººä¸­å¿ƒæ•°æ®
        function refreshProfileData() {
            // è§¦å‘åˆ·æ–°äº‹ä»¶
            window.dispatchEvent(new CustomEvent('refreshProfile', {
                detail: {
                    source: 'æ‰‹åŠ¨åˆ·æ–°',
                    timestamp: Date.now()
                }
            }));
            
            // åˆ·æ–°iframe
            const iframe = document.getElementById('profile-iframe');
            iframe.src = iframe.src;
            
            showResult('manual-test-result', 'âœ… å·²è§¦å‘ä¸ªäººä¸­å¿ƒæ•°æ®åˆ·æ–°', 'success');
        }
        
        // åº”ç”¨å¿«é€Ÿä¿®å¤
        function applyQuickFix() {
            let message = '=== åº”ç”¨å¿«é€Ÿä¿®å¤ ===\n';
            
            // 1. æ¸…é™¤å¯èƒ½çš„ç¼“å­˜æ•°æ®
            message += '1. æ¸…é™¤æœ¬åœ°ç¼“å­˜æ•°æ®...\n';
            
            // 2. é‡æ–°æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
            message += '2. é‡æ–°æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨...\n';
            
            // 3. è§¦å‘æ•°æ®åˆ·æ–°
            message += '3. è§¦å‘æ•°æ®åˆ·æ–°...\n';
            window.dispatchEvent(new CustomEvent('refreshProfile', {
                detail: { source: 'å¿«é€Ÿä¿®å¤' }
            }));
            
            // 4. åˆ·æ–°é¡µé¢ç»„ä»¶
            message += '4. åˆ·æ–°é¡µé¢ç»„ä»¶...\n';
            const iframe = document.getElementById('profile-iframe');
            iframe.src = iframe.src;
            
            message += '\nâœ… å¿«é€Ÿä¿®å¤å·²åº”ç”¨ï¼Œè¯·æ£€æŸ¥ä¸ªäººä¸­å¿ƒæ˜¯å¦æ­£å¸¸æ˜¾ç¤º';
            showResult('solution-result', message, 'success');
        }
        
        // æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°
        function clearCacheAndRefresh() {
            // æ¸…é™¤localStorageä¸­å¯èƒ½çš„ç¼“å­˜
            const keysToKeep = ['token', 'username'];
            const allKeys = Object.keys(localStorage);
            
            allKeys.forEach(key => {
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key);
                }
            });
            
            showResult('solution-result', 
                'âœ… å·²æ¸…é™¤ç¼“å­˜æ•°æ®ï¼ˆä¿ç•™ç™»å½•ä¿¡æ¯ï¼‰\nå»ºè®®åˆ·æ–°æ•´ä¸ªé¡µé¢ä»¥ç¡®ä¿å®Œå…¨é‡ç½®', 
                'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸ” ç»éªŒå€¼åŒæ­¥é—®é¢˜è¯Šæ–­å·¥å…·å·²åŠ è½½');
            
            // ç›‘å¬experienceUpdatedäº‹ä»¶ç”¨äºè°ƒè¯•
            window.addEventListener('experienceUpdated', function(event) {
                console.log('ğŸ¯ æ”¶åˆ°experienceUpdatedäº‹ä»¶:', event.detail);
            });
            
            // ç›‘å¬refreshProfileäº‹ä»¶ç”¨äºè°ƒè¯•
            window.addEventListener('refreshProfile', function(event) {
                console.log('ğŸ”„ æ”¶åˆ°refreshProfileäº‹ä»¶:', event.detail);
            });
        });
    </script>
</body>
</html>