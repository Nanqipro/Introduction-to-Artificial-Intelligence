<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ æœ€ç»ˆç»éªŒå€¼æ›´æ–°æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f7fafc;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
        }
        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .button.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        .button.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }
        .button.danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.4;
        }
        .success { background: #f0fff4; border: 1px solid #9ae6b4; color: #22543d; }
        .error { background: #fed7d7; border: 1px solid #fc8181; color: #742a2a; }
        .info { background: #ebf8ff; border: 1px solid #90cdf4; color: #2a4365; }
        .warning { background: #fef5e7; border: 1px solid #f6ad55; color: #744210; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #48bb78; }
        .status-error { background: #f56565; }
        .status-warning { background: #ed8936; }
        .status-pending { background: #a0aec0; }
        .data-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #edf2f7;
            border-radius: 6px;
        }
        .data-column {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        .data-column h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #4a5568;
        }
        .iframe-section {
            margin-top: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 500px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ æœ€ç»ˆç»éªŒå€¼æ›´æ–°æµ‹è¯•</h1>
        
        <div class="test-grid">
            <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ -->
            <div class="test-section">
                <h3>ğŸ” ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
                <div id="system-status">
                    <div><span class="status-indicator status-pending"></span>å‰ç«¯æœåŠ¡: æ£€æŸ¥ä¸­...</div>
                    <div><span class="status-indicator status-pending"></span>åç«¯æœåŠ¡: æ£€æŸ¥ä¸­...</div>
                    <div><span class="status-indicator status-pending"></span>ç”¨æˆ·ç™»å½•: æ£€æŸ¥ä¸­...</div>
                    <div><span class="status-indicator status-pending"></span>APIè¿æ¥: æ£€æŸ¥ä¸­...</div>
                </div>
                <button class="button" onclick="checkSystemStatus()">é‡æ–°æ£€æŸ¥</button>
            </div>

            <!-- å½“å‰æ•°æ®å¿«ç…§ -->
            <div class="test-section">
                <h3>ğŸ“Š å½“å‰æ•°æ®å¿«ç…§</h3>
                <div id="current-snapshot">
                    <div>ç­‰çº§: <span id="current-level">-</span></div>
                    <div>ç»éªŒå€¼: <span id="current-experience">-</span></div>
                    <div>æ€»åˆ†: <span id="current-score">-</span></div>
                    <div>å®Œæˆç« èŠ‚: <span id="current-chapters">-</span></div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">æœ€åæ›´æ–°: <span id="last-update">-</span></div>
                </div>
                <button class="button" onclick="updateSnapshot()">åˆ·æ–°å¿«ç…§</button>
            </div>
        </div>

        <!-- ç»éªŒå€¼æ›´æ–°æµ‹è¯• -->
        <div class="test-section full-width">
            <h3>ğŸš€ ç»éªŒå€¼æ›´æ–°æµ‹è¯•</h3>
            <div style="margin-bottom: 15px;">
                <button class="button success" onclick="testQuizCompletion()">æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆ</button>
                <button class="button success" onclick="testChapterCompletion()">æ¨¡æ‹Ÿç« èŠ‚å®Œæˆ</button>
                <button class="button warning" onclick="testCustomExperience()">è‡ªå®šä¹‰ç»éªŒå€¼</button>
                <button class="button" onclick="testEventOnly()">ä»…æµ‹è¯•äº‹ä»¶</button>
            </div>
            <div id="experience-test-result" class="result" style="display:none;"></div>
        </div>

        <!-- äº‹ä»¶ç›‘å¬æµ‹è¯• -->
        <div class="test-section full-width">
            <h3>ğŸ“¡ äº‹ä»¶ç›‘å¬æµ‹è¯•</h3>
            <div style="margin-bottom: 15px;">
                <button class="button" onclick="startGlobalMonitoring()">å¼€å§‹å…¨å±€ç›‘å¬</button>
                <button class="button warning" onclick="stopGlobalMonitoring()">åœæ­¢ç›‘å¬</button>
                <button class="button" onclick="triggerManualEvent()">æ‰‹åŠ¨è§¦å‘äº‹ä»¶</button>
                <button class="button danger" onclick="clearEventLog()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div id="event-monitoring-result" class="result" style="display:none;"></div>
        </div>

        <!-- ä¸ªäººä¸­å¿ƒé¡µé¢æµ‹è¯• -->
        <div class="test-section full-width">
            <h3>ğŸ‘¤ ä¸ªäººä¸­å¿ƒé¡µé¢æµ‹è¯•</h3>
            <div style="margin-bottom: 15px;">
                <button class="button" onclick="loadProfileInFrame()">åŠ è½½ä¸ªäººä¸­å¿ƒ</button>
                <button class="button" onclick="testProfileUpdate()">æµ‹è¯•é¡µé¢æ›´æ–°</button>
                <button class="button warning" onclick="hideProfileFrame()">éšè—é¡µé¢</button>
            </div>
            <div class="iframe-section" id="profile-frame-section" style="display:none;">
                <iframe id="profile-frame" src=""></iframe>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8082';
        let systemStatus = {
            frontend: false,
            backend: false,
            login: false,
            api: false
        };
        let currentData = null;
        let globalEventListener = null;
        let isMonitoring = false;
        let eventLog = [];

        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        function appendResult(elementId, message) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML += message;
        }

        function updateStatusIndicator(service, status) {
            const indicators = document.querySelectorAll('#system-status div');
            const serviceMap = {
                'frontend': 0,
                'backend': 1,
                'login': 2,
                'api': 3
            };
            
            const index = serviceMap[service];
            if (index !== undefined && indicators[index]) {
                const indicator = indicators[index].querySelector('.status-indicator');
                const text = indicators[index];
                
                indicator.className = `status-indicator status-${status ? 'success' : 'error'}`;
                
                const serviceName = {
                    'frontend': 'å‰ç«¯æœåŠ¡',
                    'backend': 'åç«¯æœåŠ¡', 
                    'login': 'ç”¨æˆ·ç™»å½•',
                    'api': 'APIè¿æ¥'
                }[service];
                
                text.innerHTML = `<span class="status-indicator status-${status ? 'success' : 'error'}"></span>${serviceName}: ${status ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`;
            }
        }

        async function checkSystemStatus() {
            // æ£€æŸ¥å‰ç«¯æœåŠ¡
            try {
                const frontendResponse = await fetch('http://localhost:5174/');
                systemStatus.frontend = frontendResponse.ok;
            } catch {
                systemStatus.frontend = false;
            }
            updateStatusIndicator('frontend', systemStatus.frontend);

            // æ£€æŸ¥åç«¯æœåŠ¡
            try {
                const backendResponse = await fetch(`${API_BASE}/api/health`, { method: 'GET' });
                systemStatus.backend = backendResponse.ok;
            } catch {
                systemStatus.backend = false;
            }
            updateStatusIndicator('backend', systemStatus.backend);

            // æ£€æŸ¥ç”¨æˆ·ç™»å½•
            const token = localStorage.getItem('token');
            systemStatus.login = token && token !== 'null' && token.trim() !== '';
            updateStatusIndicator('login', systemStatus.login);

            // æ£€æŸ¥APIè¿æ¥
            if (systemStatus.login) {
                try {
                    const apiResponse = await fetch(`${API_BASE}/api/users/userInfo`, {
                        headers: getAuthHeaders()
                    });
                    systemStatus.api = apiResponse.ok;
                } catch {
                    systemStatus.api = false;
                }
            } else {
                systemStatus.api = false;
            }
            updateStatusIndicator('api', systemStatus.api);
        }

        async function updateSnapshot() {
            if (!systemStatus.login || !systemStatus.api) {
                document.getElementById('current-level').textContent = 'æœªç™»å½•';
                document.getElementById('current-experience').textContent = 'æœªç™»å½•';
                document.getElementById('current-score').textContent = 'æœªç™»å½•';
                document.getElementById('current-chapters').textContent = 'æœªç™»å½•';
                document.getElementById('last-update').textContent = 'æœªç™»å½•';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/level/stats`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentData = data.data;
                    
                    document.getElementById('current-level').textContent = currentData.level || 0;
                    document.getElementById('current-experience').textContent = currentData.experience || 0;
                    document.getElementById('current-score').textContent = currentData.totalScore || 0;
                    document.getElementById('current-chapters').textContent = currentData.completedChapters || 0;
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                } else {
                    throw new Error('APIå“åº”å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('current-level').textContent = 'é”™è¯¯';
                document.getElementById('current-experience').textContent = 'é”™è¯¯';
                document.getElementById('current-score').textContent = 'é”™è¯¯';
                document.getElementById('current-chapters').textContent = 'é”™è¯¯';
                document.getElementById('last-update').textContent = 'é”™è¯¯';
            }
        }

        async function testQuizCompletion() {
            let message = '=== ğŸ¯ æ¨¡æ‹Ÿæµ‹éªŒå®Œæˆæµç¨‹ ===\n';
            showResult('experience-test-result', message, 'info');
            
            // è·å–æ›´æ–°å‰æ•°æ®
            await updateSnapshot();
            const beforeData = { ...currentData };
            
            message += `ğŸ“Š æ›´æ–°å‰æ•°æ®:\n`;
            message += `- ç­‰çº§: ${beforeData.level}\n`;
            message += `- ç»éªŒå€¼: ${beforeData.experience}\n`;
            message += `- æ€»åˆ†: ${beforeData.totalScore}\n`;
            message += `- å®Œæˆç« èŠ‚: ${beforeData.completedChapters}\n\n`;
            
            try {
                // æ¨¡æ‹ŸQuizSystemçš„é€»è¾‘
                const score = 85;
                const experienceGained = score + 10; // åˆ†æ•° + å¥–åŠ±
                
                const requestData = {
                    experience: experienceGained,
                    activityType: 'quiz_completion',
                    chapterId: 1,
                    score: score
                };
                
                message += `ğŸ¯ æ¨¡æ‹Ÿæµ‹éªŒ: å¾—åˆ†${score}ï¼Œè·å¾—${experienceGained}ç»éªŒå€¼\n`;
                message += `ğŸ“¤ è°ƒç”¨API: /api/level/addExperience\n`;
                
                const response = await fetch(`${API_BASE}/api/level/addExperience`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestData)
                });
                
                const responseData = await response.json();
                
                if (response.ok && responseData.code === 200) {
                    message += `âœ… APIè°ƒç”¨æˆåŠŸ\n`;
                    message += `ğŸ“ˆ æ–°ç»éªŒå€¼: ${responseData.data.experience}\n`;
                    message += `ğŸ“Š æ–°ç­‰çº§: ${responseData.data.newLevel}\n`;
                    
                    // è§¦å‘äº‹ä»¶ï¼ˆæ¨¡æ‹ŸQuizSystemçš„è¡Œä¸ºï¼‰
                    message += `\nğŸ“¡ è§¦å‘ç»éªŒå€¼æ›´æ–°äº‹ä»¶...\n`;
                    const eventData = {
                        experienceGained: experienceGained,
                        newExperience: responseData.data.experience,
                        newLevel: responseData.data.newLevel,
                        leveledUp: responseData.data.levelUp
                    };
                    
                    window.dispatchEvent(new CustomEvent('experienceUpdated', {
                        detail: eventData
                    }));
                    
                    message += `âœ… äº‹ä»¶å·²è§¦å‘\n`;
                    
                    // ç­‰å¾…ä¸€ä¸‹å†éªŒè¯æ•°æ®
                    message += `\nâ³ ç­‰å¾…æ•°æ®æ›´æ–°...\n`;
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    await updateSnapshot();
                    const afterData = { ...currentData };
                    
                    message += `\nğŸ“Š æ›´æ–°åæ•°æ®:\n`;
                    message += `- ç­‰çº§: ${afterData.level} (${afterData.level - beforeData.level >= 0 ? '+' : ''}${afterData.level - beforeData.level})\n`;
                    message += `- ç»éªŒå€¼: ${afterData.experience} (${afterData.experience - beforeData.experience >= 0 ? '+' : ''}${afterData.experience - beforeData.experience})\n`;
                    message += `- æ€»åˆ†: ${afterData.totalScore} (${afterData.totalScore - beforeData.totalScore >= 0 ? '+' : ''}${afterData.totalScore - beforeData.totalScore})\n`;
                    message += `- å®Œæˆç« èŠ‚: ${afterData.completedChapters} (${afterData.completedChapters - beforeData.completedChapters >= 0 ? '+' : ''}${afterData.completedChapters - beforeData.completedChapters})\n`;
                    
                    const hasExpChange = afterData.experience !== beforeData.experience;
                    const hasScoreChange = afterData.totalScore !== beforeData.totalScore;
                    
                    if (hasExpChange || hasScoreChange) {
                        message += `\nğŸ‰ æµ‹éªŒå®Œæˆæµç¨‹æµ‹è¯•æˆåŠŸï¼æ•°æ®å·²æ›´æ–°`;
                        showResult('experience-test-result', message, 'success');
                    } else {
                        message += `\nâš ï¸ æ•°æ®æœªå‘ç”Ÿå˜åŒ–ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜`;
                        showResult('experience-test-result', message, 'warning');
                    }
                } else {
                    message += `âŒ APIè°ƒç”¨å¤±è´¥: ${responseData.message || 'æœªçŸ¥é”™è¯¯'}`;
                    showResult('experience-test-result', message, 'error');
                }
            } catch (error) {
                message += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`;
                showResult('experience-test-result', message, 'error');
            }
        }

        async function testChapterCompletion() {
            let message = '=== ğŸ“š æ¨¡æ‹Ÿç« èŠ‚å®Œæˆæµç¨‹ ===\n';
            showResult('experience-test-result', message, 'info');
            
            await updateSnapshot();
            const beforeData = { ...currentData };
            
            try {
                const requestData = {
                    experience: 50,
                    activityType: 'chapter',
                    chapterId: 2,
                    score: 100
                };
                
                message += `ğŸ“š æ¨¡æ‹Ÿç« èŠ‚å®Œæˆ: ç¬¬${requestData.chapterId}ç« ï¼Œè·å¾—${requestData.experience}ç»éªŒå€¼\n`;
                
                const response = await fetch(`${API_BASE}/api/level/addExperience`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestData)
                });
                
                const responseData = await response.json();
                
                if (response.ok && responseData.code === 200) {
                    message += `âœ… APIè°ƒç”¨æˆåŠŸ\n`;
                    
                    // è§¦å‘äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('experienceUpdated', {
                        detail: {
                            experienceGained: 50,
                            newExperience: responseData.data.experience,
                            newLevel: responseData.data.newLevel,
                            leveledUp: responseData.data.levelUp
                        }
                    }));
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    await updateSnapshot();
                    
                    const expDiff = currentData.experience - beforeData.experience;
                    const chapterDiff = currentData.completedChapters - beforeData.completedChapters;
                    
                    message += `\nğŸ“Š æ•°æ®å˜åŒ–:\n`;
                    message += `- ç»éªŒå€¼: +${expDiff}\n`;
                    message += `- å®Œæˆç« èŠ‚: +${chapterDiff}\n`;
                    
                    if (expDiff > 0 || chapterDiff > 0) {
                        message += `\nğŸ‰ ç« èŠ‚å®Œæˆæµç¨‹æµ‹è¯•æˆåŠŸï¼`;
                        showResult('experience-test-result', message, 'success');
                    } else {
                        message += `\nâš ï¸ æ•°æ®æœªæ›´æ–°`;
                        showResult('experience-test-result', message, 'warning');
                    }
                } else {
                    message += `âŒ APIè°ƒç”¨å¤±è´¥: ${responseData.message}`;
                    showResult('experience-test-result', message, 'error');
                }
            } catch (error) {
                message += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`;
                showResult('experience-test-result', message, 'error');
            }
        }

        async function testCustomExperience() {
            const experience = prompt('è¯·è¾“å…¥è¦æ·»åŠ çš„ç»éªŒå€¼:', '30');
            if (!experience || isNaN(experience)) return;
            
            let message = `=== ğŸ¯ è‡ªå®šä¹‰ç»éªŒå€¼æµ‹è¯• (+${experience}) ===\n`;
            showResult('experience-test-result', message, 'info');
            
            await updateSnapshot();
            const beforeExp = currentData.experience;
            
            try {
                const requestData = {
                    experience: parseInt(experience),
                    activityType: 'custom_test',
                    chapterId: 1,
                    score: parseInt(experience)
                };
                
                const response = await fetch(`${API_BASE}/api/level/addExperience`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestData)
                });
                
                const responseData = await response.json();
                
                if (response.ok && responseData.code === 200) {
                    message += `âœ… APIè°ƒç”¨æˆåŠŸ\n`;
                    
                    window.dispatchEvent(new CustomEvent('experienceUpdated', {
                        detail: {
                            experienceGained: parseInt(experience),
                            newExperience: responseData.data.experience,
                            newLevel: responseData.data.newLevel,
                            leveledUp: responseData.data.levelUp
                        }
                    }));
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    await updateSnapshot();
                    
                    const expDiff = currentData.experience - beforeExp;
                    message += `\nğŸ“Š ç»éªŒå€¼å˜åŒ–: ${beforeExp} â†’ ${currentData.experience} (+${expDiff})\n`;
                    
                    if (expDiff > 0) {
                        message += `ğŸ‰ è‡ªå®šä¹‰ç»éªŒå€¼æµ‹è¯•æˆåŠŸï¼`;
                        showResult('experience-test-result', message, 'success');
                    } else {
                        message += `âš ï¸ ç»éªŒå€¼æœªå¢åŠ `;
                        showResult('experience-test-result', message, 'warning');
                    }
                } else {
                    message += `âŒ APIè°ƒç”¨å¤±è´¥: ${responseData.message}`;
                    showResult('experience-test-result', message, 'error');
                }
            } catch (error) {
                message += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`;
                showResult('experience-test-result', message, 'error');
            }
        }

        function testEventOnly() {
            let message = '=== ğŸ“¡ ä»…æµ‹è¯•äº‹ä»¶è§¦å‘ ===\n';
            
            const testEventData = {
                experienceGained: 25,
                newExperience: (currentData?.experience || 0) + 25,
                newLevel: currentData?.level || 1,
                leveledUp: false
            };
            
            message += `ğŸ“¤ è§¦å‘experienceUpdatedäº‹ä»¶...\n`;
            message += `äº‹ä»¶æ•°æ®: ${JSON.stringify(testEventData, null, 2)}\n`;
            
            window.dispatchEvent(new CustomEvent('experienceUpdated', {
                detail: testEventData
            }));
            
            message += `âœ… äº‹ä»¶å·²è§¦å‘ï¼Œè¯·æŸ¥çœ‹äº‹ä»¶ç›‘å¬æ—¥å¿—`;
            showResult('experience-test-result', message, 'info');
        }

        function startGlobalMonitoring() {
            if (isMonitoring) {
                showResult('event-monitoring-result', 'âš ï¸ å·²åœ¨ç›‘å¬äº‹ä»¶', 'warning');
                return;
            }
            
            isMonitoring = true;
            eventLog = [];
            let message = 'ğŸ” å¼€å§‹å…¨å±€äº‹ä»¶ç›‘å¬...\n\n';
            
            globalEventListener = (event) => {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    timestamp,
                    detail: event.detail
                };
                eventLog.push(logEntry);
                
                message += `[${timestamp}] ğŸ“¡ æ”¶åˆ°experienceUpdatedäº‹ä»¶:\n`;
                message += `${JSON.stringify(event.detail, null, 2)}\n\n`;
                
                showResult('event-monitoring-result', message, 'success');
            };
            
            window.addEventListener('experienceUpdated', globalEventListener);
            showResult('event-monitoring-result', message, 'info');
        }

        function stopGlobalMonitoring() {
            if (!isMonitoring) {
                showResult('event-monitoring-result', 'âš ï¸ æœªåœ¨ç›‘å¬äº‹ä»¶', 'warning');
                return;
            }
            
            isMonitoring = false;
            if (globalEventListener) {
                window.removeEventListener('experienceUpdated', globalEventListener);
                globalEventListener = null;
            }
            
            let message = `ğŸ›‘ åœæ­¢äº‹ä»¶ç›‘å¬\n\n`;
            message += `ğŸ“Š ç›‘å¬ç»Ÿè®¡:\n`;
            message += `- æ€»äº‹ä»¶æ•°: ${eventLog.length}\n`;
            message += `- ç›‘å¬æ—¶é•¿: ${eventLog.length > 0 ? 'ä» ' + eventLog[0].timestamp + ' åˆ° ' + eventLog[eventLog.length - 1].timestamp : 'æ— äº‹ä»¶'}`;
            
            showResult('event-monitoring-result', message, 'info');
        }

        function triggerManualEvent() {
            const eventData = {
                experienceGained: 15,
                newExperience: (currentData?.experience || 0) + 15,
                newLevel: currentData?.level || 1,
                leveledUp: false,
                source: 'manual_trigger'
            };
            
            window.dispatchEvent(new CustomEvent('experienceUpdated', {
                detail: eventData
            }));
            
            if (!isMonitoring) {
                showResult('event-monitoring-result', 'ğŸ“¤ å·²è§¦å‘æ‰‹åŠ¨äº‹ä»¶ï¼ˆè¯·å…ˆå¼€å§‹ç›‘å¬ä»¥æŸ¥çœ‹ç»“æœï¼‰', 'info');
            }
        }

        function clearEventLog() {
            eventLog = [];
            showResult('event-monitoring-result', 'ğŸ—‘ï¸ äº‹ä»¶æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        function loadProfileInFrame() {
            const iframe = document.getElementById('profile-frame');
            const section = document.getElementById('profile-frame-section');
            
            iframe.src = 'http://localhost:5174/profile';
            section.style.display = 'block';
        }

        async function testProfileUpdate() {
            if (!currentData) {
                showResult('experience-test-result', 'âŒ è¯·å…ˆæ›´æ–°æ•°æ®å¿«ç…§', 'error');
                return;
            }
            
            let message = '=== ğŸ‘¤ æµ‹è¯•ä¸ªäººä¸­å¿ƒé¡µé¢æ›´æ–° ===\n';
            
            // å…ˆæ·»åŠ ç»éªŒå€¼
            message += '1ï¸âƒ£ æ·»åŠ ç»éªŒå€¼...\n';
            
            try {
                const response = await fetch(`${API_BASE}/api/level/addExperience`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        experience: 20,
                        activityType: 'profile_test',
                        chapterId: 1,
                        score: 20
                    })
                });
                
                const responseData = await response.json();
                
                if (response.ok && responseData.code === 200) {
                    message += 'âœ… ç»éªŒå€¼æ·»åŠ æˆåŠŸ\n';
                    
                    // è§¦å‘äº‹ä»¶
                    message += '2ï¸âƒ£ è§¦å‘æ›´æ–°äº‹ä»¶...\n';
                    window.dispatchEvent(new CustomEvent('experienceUpdated', {
                        detail: {
                            experienceGained: 20,
                            newExperience: responseData.data.experience,
                            newLevel: responseData.data.newLevel,
                            leveledUp: responseData.data.levelUp
                        }
                    }));
                    
                    message += 'âœ… äº‹ä»¶å·²è§¦å‘\n';
                    message += '3ï¸âƒ£ æ£€æŸ¥ä¸ªäººä¸­å¿ƒé¡µé¢æ˜¯å¦æ›´æ–°...\n';
                    message += 'ğŸ’¡ è¯·è§‚å¯Ÿiframeä¸­çš„ä¸ªäººä¸­å¿ƒé¡µé¢æ•°æ®æ˜¯å¦è‡ªåŠ¨æ›´æ–°';
                    
                    showResult('experience-test-result', message, 'success');
                } else {
                    message += `âŒ ç»éªŒå€¼æ·»åŠ å¤±è´¥: ${responseData.message}`;
                    showResult('experience-test-result', message, 'error');
                }
            } catch (error) {
                message += `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`;
                showResult('experience-test-result', message, 'error');
            }
        }

        function hideProfileFrame() {
            const section = document.getElementById('profile-frame-section');
            section.style.display = 'none';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.onload = async function() {
            await checkSystemStatus();
            if (systemStatus.login && systemStatus.api) {
                await updateSnapshot();
            }
        };
    </script>
</body>
</html>