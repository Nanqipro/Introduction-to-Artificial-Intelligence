<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: #28a745;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #17a2b8;
            background: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .data-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ APIè¿æ¥å’Œæ•°æ®åŒæ­¥æµ‹è¯•</h1>
        <p>æµ‹è¯•å‰ç«¯ä¸åç«¯APIçš„è¿æ¥çŠ¶æ€ï¼Œä»¥åŠä¸ªäººä¸­å¿ƒæ•°æ®åŒæ­¥åŠŸèƒ½</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>ğŸ“Š å½“å‰ç”¨æˆ·çŠ¶æ€</h3>
            <div id="userStatus">æ£€æŸ¥ä¸­...</div>
            <button onclick="checkUserStatus()">åˆ·æ–°ç”¨æˆ·çŠ¶æ€</button>
        </div>

        <div class="test-section">
            <h3>ğŸŒ APIè¿æ¥æµ‹è¯•</h3>
            <button onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
            <button onclick="testUserStatsAPI()">æµ‹è¯•ç”¨æˆ·ç»Ÿè®¡API</button>
            <button onclick="testUserAchievementsAPI()">æµ‹è¯•ç”¨æˆ·æˆå°±API</button>
            <div id="apiTestResults"></div>
        </div>

        <div class="test-section">
            <h3>âš¡ ç»éªŒå€¼æ›´æ–°æµ‹è¯•</h3>
            <button onclick="simulateExperienceUpdate()">æ¨¡æ‹Ÿç»éªŒå€¼æ›´æ–°</button>
            <button onclick="triggerProfileRefresh()">æ‰‹åŠ¨è§¦å‘ä¸ªäººä¸­å¿ƒåˆ·æ–°</button>
            <div id="experienceTestResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æ•°æ®åŒæ­¥æµç¨‹</button>
            <div id="flowTestResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logElement = document.getElementById('testLog');
            logElement.textContent = testLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function clearLog() {
            testLog = [];
            document.getElementById('testLog').textContent = '';
        }

        function displayResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${content}</div>`;
        }

        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        async function checkUserStatus() {
            log('æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€...');
            
            const token = localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            
            let statusHtml = '<div class="data-display">';
            statusHtml += `<div class="data-item"><strong>Token:</strong> ${token ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</div>`;
            
            if (userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    statusHtml += `<div class="data-item"><strong>ç”¨æˆ·ID:</strong> ${user.id}</div>`;
                    statusHtml += `<div class="data-item"><strong>ç”¨æˆ·å:</strong> ${user.username}</div>`;
                    statusHtml += `<div class="data-item"><strong>æ˜µç§°:</strong> ${user.nickname || 'æœªè®¾ç½®'}</div>`;
                } catch (e) {
                    statusHtml += `<div class="data-item"><strong>ç”¨æˆ·ä¿¡æ¯:</strong> âŒ è§£æå¤±è´¥</div>`;
                }
            } else {
                statusHtml += `<div class="data-item"><strong>ç”¨æˆ·ä¿¡æ¯:</strong> âŒ ä¸å­˜åœ¨</div>`;
            }
            statusHtml += '</div>';
            
            document.getElementById('userStatus').innerHTML = statusHtml;
            log('ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å®Œæˆ');
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            log('å¼€å§‹æµ‹è¯•APIè¿æ¥...');
            
            try {
                // æµ‹è¯•åŸºæœ¬è¿æ¥
                const response = await fetch('http://localhost:8082/api/level/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('APIè¿æ¥æˆåŠŸ');
                    displayResult('apiTestResults', 'âœ… APIè¿æ¥æ­£å¸¸', 'success');
                } else {
                    log(`APIå“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
                    displayResult('apiTestResults', `âŒ APIè¿æ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`APIè¿æ¥å¼‚å¸¸: ${error.message}`);
                displayResult('apiTestResults', `âŒ APIè¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ç”¨æˆ·ç»Ÿè®¡API
        async function testUserStatsAPI() {
            log('æµ‹è¯•ç”¨æˆ·ç»Ÿè®¡API...');
            
            try {
                const response = await fetch('http://localhost:8082/api/level/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('ç”¨æˆ·ç»Ÿè®¡APIè°ƒç”¨æˆåŠŸ');
                    log(`è¿”å›æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                    
                    let resultHtml = '<div class="data-display"><h4>ç”¨æˆ·ç»Ÿè®¡æ•°æ®:</h4>';
                    if (data.data) {
                        const stats = data.data;
                        resultHtml += `<div class="data-item"><strong>ç­‰çº§:</strong> ${stats.level}</div>`;
                        resultHtml += `<div class="data-item"><strong>ç»éªŒå€¼:</strong> ${stats.experience}</div>`;
                        resultHtml += `<div class="data-item"><strong>æ€»å¾—åˆ†:</strong> ${stats.totalScore}</div>`;
                        resultHtml += `<div class="data-item"><strong>å·²å®Œæˆç« èŠ‚:</strong> ${stats.completedChapters}</div>`;
                        resultHtml += `<div class="data-item"><strong>å­¦ä¹ æ—¶é—´:</strong> ${stats.studyTime}åˆ†é’Ÿ</div>`;
                        resultHtml += `<div class="data-item"><strong>ç½‘ç»œè¿›åº¦:</strong> ${stats.networkProgress}%</div>`;
                        resultHtml += `<div class="data-item"><strong>åè®®è¿›åº¦:</strong> ${stats.protocolProgress}%</div>`;
                        resultHtml += `<div class="data-item"><strong>å®è·µè¿›åº¦:</strong> ${stats.practiceProgress}%</div>`;
                    }
                    resultHtml += '</div>';
                    
                    displayResult('apiTestResults', resultHtml, 'success');
                } else {
                    log(`ç”¨æˆ·ç»Ÿè®¡APIé”™è¯¯: ${response.status}`);
                    displayResult('apiTestResults', `âŒ ç”¨æˆ·ç»Ÿè®¡APIå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`ç”¨æˆ·ç»Ÿè®¡APIå¼‚å¸¸: ${error.message}`);
                displayResult('apiTestResults', `âŒ ç”¨æˆ·ç»Ÿè®¡APIå¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ç”¨æˆ·æˆå°±API
        async function testUserAchievementsAPI() {
            log('æµ‹è¯•ç”¨æˆ·æˆå°±API...');
            
            try {
                const response = await fetch('http://localhost:8082/api/level/achievements', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('ç”¨æˆ·æˆå°±APIè°ƒç”¨æˆåŠŸ');
                    log(`è¿”å›æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                    
                    let resultHtml = '<div class="data-display"><h4>ç”¨æˆ·æˆå°±æ•°æ®:</h4>';
                    if (data.data && data.data.length > 0) {
                        data.data.forEach((achievement, index) => {
                            resultHtml += `<div class="data-item">`;
                            resultHtml += `<strong>æˆå°±${index + 1}:</strong> ${achievement.title} - ${achievement.description}`;
                            resultHtml += `</div>`;
                        });
                    } else {
                        resultHtml += '<div class="data-item">æš‚æ— æˆå°±æ•°æ®</div>';
                    }
                    resultHtml += '</div>';
                    
                    displayResult('apiTestResults', resultHtml, 'success');
                } else {
                    log(`ç”¨æˆ·æˆå°±APIé”™è¯¯: ${response.status}`);
                    displayResult('apiTestResults', `âŒ ç”¨æˆ·æˆå°±APIå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`ç”¨æˆ·æˆå°±APIå¼‚å¸¸: ${error.message}`);
                displayResult('apiTestResults', `âŒ ç”¨æˆ·æˆå°±APIå¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æ¨¡æ‹Ÿç»éªŒå€¼æ›´æ–°
        async function simulateExperienceUpdate() {
            log('æ¨¡æ‹Ÿç»éªŒå€¼æ›´æ–°...');
            
            try {
                // å…ˆè·å–å½“å‰ç»éªŒå€¼
                const currentStatsResponse = await fetch('http://localhost:8082/api/level/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!currentStatsResponse.ok) {
                    throw new Error('æ— æ³•è·å–å½“å‰ç»Ÿè®¡æ•°æ®');
                }
                
                const currentStats = await currentStatsResponse.json();
                const currentExp = currentStats.data.experience;
                log(`å½“å‰ç»éªŒå€¼: ${currentExp}`);
                
                // æ·»åŠ ç»éªŒå€¼
                const addExpResponse = await fetch('http://localhost:8082/api/level/add-experience', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experience: 10,
                        source: 'APIæµ‹è¯•'
                    })
                });
                
                if (addExpResponse.ok) {
                    const result = await addExpResponse.json();
                    log('ç»éªŒå€¼æ·»åŠ æˆåŠŸ');
                    log(`æ·»åŠ ç»“æœ: ${JSON.stringify(result, null, 2)}`);
                    
                    // è§¦å‘experienceUpdatedäº‹ä»¶
                    const event = new CustomEvent('experienceUpdated', {
                        detail: {
                            experienceGained: 10,
                            newExperience: currentExp + 10,
                            newLevel: result.data?.newLevel || currentStats.data.level,
                            source: 'APIæµ‹è¯•'
                        }
                    });
                    
                    window.dispatchEvent(event);
                    log('å·²è§¦å‘experienceUpdatedäº‹ä»¶');
                    
                    displayResult('experienceTestResults', 'âœ… ç»éªŒå€¼æ›´æ–°æˆåŠŸï¼Œå·²è§¦å‘äº‹ä»¶', 'success');
                } else {
                    log(`ç»éªŒå€¼æ·»åŠ å¤±è´¥: ${addExpResponse.status}`);
                    displayResult('experienceTestResults', `âŒ ç»éªŒå€¼æ·»åŠ å¤±è´¥: ${addExpResponse.status}`, 'error');
                }
            } catch (error) {
                log(`ç»éªŒå€¼æ›´æ–°å¼‚å¸¸: ${error.message}`);
                displayResult('experienceTestResults', `âŒ ç»éªŒå€¼æ›´æ–°å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æ‰‹åŠ¨è§¦å‘ä¸ªäººä¸­å¿ƒåˆ·æ–°
        function triggerProfileRefresh() {
            log('æ‰‹åŠ¨è§¦å‘ä¸ªäººä¸­å¿ƒåˆ·æ–°...');
            
            // è§¦å‘è‡ªå®šä¹‰åˆ·æ–°äº‹ä»¶
            const event = new CustomEvent('refreshProfile', {
                detail: {
                    source: 'æ‰‹åŠ¨è§¦å‘',
                    timestamp: Date.now()
                }
            });
            
            window.dispatchEvent(event);
            log('å·²è§¦å‘refreshProfileäº‹ä»¶');
            
            displayResult('experienceTestResults', 'âœ… å·²è§¦å‘ä¸ªäººä¸­å¿ƒåˆ·æ–°äº‹ä»¶', 'info');
        }

        // æµ‹è¯•å®Œæ•´æµç¨‹
        async function testCompleteFlow() {
            log('å¼€å§‹æµ‹è¯•å®Œæ•´æ•°æ®åŒæ­¥æµç¨‹...');
            
            try {
                // 1. è·å–åˆå§‹æ•°æ®
                log('æ­¥éª¤1: è·å–åˆå§‹ç”¨æˆ·æ•°æ®');
                const initialResponse = await fetch('http://localhost:8082/api/level/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!initialResponse.ok) {
                    throw new Error('æ— æ³•è·å–åˆå§‹æ•°æ®');
                }
                
                const initialData = await initialResponse.json();
                log(`åˆå§‹ç»éªŒå€¼: ${initialData.data.experience}`);
                
                // 2. æ·»åŠ ç»éªŒå€¼
                log('æ­¥éª¤2: æ·»åŠ ç»éªŒå€¼');
                const addExpResponse = await fetch('http://localhost:8082/api/level/add-experience', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experience: 15,
                        source: 'å®Œæ•´æµç¨‹æµ‹è¯•'
                    })
                });
                
                if (!addExpResponse.ok) {
                    throw new Error('ç»éªŒå€¼æ·»åŠ å¤±è´¥');
                }
                
                const addResult = await addExpResponse.json();
                log('ç»éªŒå€¼æ·»åŠ æˆåŠŸ');
                
                // 3. è§¦å‘äº‹ä»¶
                log('æ­¥éª¤3: è§¦å‘experienceUpdatedäº‹ä»¶');
                const event = new CustomEvent('experienceUpdated', {
                    detail: {
                        experienceGained: 15,
                        newExperience: initialData.data.experience + 15,
                        newLevel: addResult.data?.newLevel || initialData.data.level,
                        source: 'å®Œæ•´æµç¨‹æµ‹è¯•'
                    }
                });
                
                window.dispatchEvent(event);
                log('äº‹ä»¶è§¦å‘å®Œæˆ');
                
                // 4. ç­‰å¾…ä¸€æ®µæ—¶é—´åéªŒè¯æ•°æ®
                log('æ­¥éª¤4: ç­‰å¾…æ•°æ®åŒæ­¥...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 5. éªŒè¯æœ€æ–°æ•°æ®
                log('æ­¥éª¤5: éªŒè¯æœ€æ–°æ•°æ®');
                const finalResponse = await fetch('http://localhost:8082/api/level/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (finalResponse.ok) {
                    const finalData = await finalResponse.json();
                    log(`æœ€ç»ˆç»éªŒå€¼: ${finalData.data.experience}`);
                    
                    const expectedExp = initialData.data.experience + 15;
                    const actualExp = finalData.data.experience;
                    
                    if (actualExp >= expectedExp) {
                        log('âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸ');
                        displayResult('flowTestResults', 
                            `âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸ<br>
                            åˆå§‹ç»éªŒå€¼: ${initialData.data.experience}<br>
                            æ·»åŠ ç»éªŒå€¼: 15<br>
                            æœ€ç»ˆç»éªŒå€¼: ${actualExp}`, 
                            'success'
                        );
                    } else {
                        log('âŒ æ•°æ®åŒæ­¥å¯èƒ½å­˜åœ¨é—®é¢˜');
                        displayResult('flowTestResults', 
                            `âš ï¸ æ•°æ®åŒæ­¥å¯èƒ½å­˜åœ¨é—®é¢˜<br>
                            æœŸæœ›ç»éªŒå€¼: ${expectedExp}<br>
                            å®é™…ç»éªŒå€¼: ${actualExp}`, 
                            'error'
                        );
                    }
                } else {
                    throw new Error('æ— æ³•è·å–æœ€ç»ˆæ•°æ®');
                }
                
            } catch (error) {
                log(`å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`);
                displayResult('flowTestResults', `âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç›‘å¬experienceUpdatedäº‹ä»¶
        window.addEventListener('experienceUpdated', function(event) {
            log(`æ”¶åˆ°experienceUpdatedäº‹ä»¶: ${JSON.stringify(event.detail)}`);
        });

        // ç›‘å¬refreshProfileäº‹ä»¶
        window.addEventListener('refreshProfile', function(event) {
            log(`æ”¶åˆ°refreshProfileäº‹ä»¶: ${JSON.stringify(event.detail)}`);
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        window.addEventListener('load', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ£€æŸ¥');
            checkUserStatus();
        });
    </script>
</body>
</html>