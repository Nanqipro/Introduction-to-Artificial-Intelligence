# 花生壳内网穿透配置说明

## 问题描述
外网访问时用户注册功能出现网络连接失败错误，原因是花生壳只暴露了5173端口，前端无法直接访问后端8082端口。

## 解决方案

### 1. 前端配置修改（已完成）
- 修改了 `client/src/services/api.js` 中的 baseURL 配置
- 外网访问时使用代理路径：`/api`
- 内网开发时使用 `http://localhost:8082`
- Vite开发服务器配置了代理，将 `/api` 请求转发到 `http://localhost:8082`

### 2. 后端CORS配置（已完成）
- 后端已配置允许花生壳域名 `https://102qldp675617.vicp.fun` 和 `https://102qldp675617.vicp.fun:8082` 的跨域访问

### 3. 花生壳配置要求

#### 单端口映射配置（推荐）
在花生壳管理后台只需配置一个端口映射：

```
映射 - 前端服务（包含API代理）:
域名: https://102qldp675617.vicp.fun
内网地址: 127.0.0.1:5173
```

这样配置后：
- 前端页面通过 `https://102qldp675617.vicp.fun` 访问
- 后端API通过 `https://102qldp675617.vicp.fun/api` 访问
- Vite开发服务器自动将API请求代理到后端8082端口

### 4. 当前服务状态
- 前端服务：运行在 localhost:5173 ✅
- 后端服务：运行在 localhost:8082 ✅
- 跨域配置：已支持花生壳域名访问 ✅
- API代理：外网通过/api路径访问后端 ✅

### 5. 验证步骤
1. 确保花生壳配置了5173端口映射
2. 通过 `https://102qldp675617.vicp.fun` 访问前端页面
3. 尝试用户注册功能，应该可以正常工作
4. 检查浏览器开发者工具，API请求应该指向 `https://102qldp675617.vicp.fun/api/*`
- 数据库：运行在 localhost:3307

### 花生壳当前配置
**前端服务映射：**
- 内网服务：127.0.0.1:5173
- 域名指向IP：115.236.153.177
- 映射IP地址：115.236.153.177

**❌ 当前缺失：后端服务映射**
- 内网服务：127.0.0.1:8082
- 外网端口：8082
- 域名：与前端使用相同域名

**⚠️ 问题原因：** 花生壳只映射了前端5173端口，未映射后端8082端口，导致 `net::ERR_CONNECTION_CLOSED` 错误

根据此配置，外网访问流程为：
1. 用户访问花生壳域名（前端页面）
2. 花生壳将请求转发到 127.0.0.1:5173（前端服务）
3. 前端通过域名:8082访问后端API
4. 花生壳将API请求转发到 127.0.0.1:8082（后端服务）

### 5. 解决方案

#### 方案一：花生壳添加8082端口映射（推荐）
1. 登录花生壳管理后台
2. 添加新的端口映射：
   - 内网主机：127.0.0.1
   - 内网端口：8082
   - 外网端口：8082
   - 协议：TCP
3. 保存配置并等待生效

#### 方案二：前端代理方式（备选）
如果花生壳不支持多端口映射，可以修改前端配置使用代理：

```javascript
// 修改 client/src/services/api.js 中的 getBaseURL 函数
const getBaseURL = () => {
  if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
    // 使用相对路径，通过前端服务代理
    return '/api'
  }
  return 'http://localhost:8082'
}
```

然后在 `vite.config.js` 中确保代理配置正确。

### 6. 测试步骤
1. 实施上述任一解决方案
2. 通过外网访问 `https://102qldp675617.vicp.fun`
3. 测试注册功能是否正常
4. 检查浏览器开发者工具中的网络请求

### 6. 故障排查
如果仍有问题，请检查：
1. 花生壳是否正确配置了端口映射或反向代理
2. 防火墙是否阻止了8082端口
3. 后端服务是否正常运行
4. 浏览器控制台是否有其他错误信息

## 注意事项
- 花生壳的具体配置界面可能因版本而异
- 建议优先使用反向代理方案，避免暴露后端端口
- 确保所有服务都在运行状态